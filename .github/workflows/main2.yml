name: Deploy Styled Index

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate styled index.html
        run: |
          python << 'EOF'
          import os
          from collections import defaultdict
          from html import escape

          TEMPLATE_PATH = "File Index.html"
          OUTPUT_PATH = "index.html"

          categories = defaultdict(list)

          for root, _, files in os.walk("."):
            if root.startswith("./.git"):
              continue
            for file in files:
              if file.endswith(".html") and file not in ["index.html", "File Index.html"]:
                folder = root.replace("./", "").split("/")[0]
                categories[folder].append(os.path.join(root, file).replace("./", ""))

          with open(TEMPLATE_PATH, "r", encoding="utf-8") as f:
            template = f.read()

          blocks = []

          ICONS = {
            "Art": "ðŸŽ¨",
            "Coding": "ðŸ’»",
            "Games": "ðŸ•¹ï¸",
            "Music": "ðŸŽµ",
            "Guides": "ðŸ“š",
            "Tools": "ðŸ› ï¸",
            "Writing": "âœï¸",
            "Emulators": "ðŸŽ®",
            "Other": "ðŸ“"
          }

          for category, files in sorted(categories.items()):
            icon = ICONS.get(category, "ðŸ“")
            items = "\n".join(
              f'''<li><a href="./{escape(f)}">
              <span class="file-icon">ðŸ“„</span>
              <span class="file-name">{escape(os.path.basename(f))}</span>
              </a></li>'''
              for f in sorted(files)
            )

            blocks.append(f"""
            <div class="category cat-{category.lower()}">
              <div class="category-header">
                <div class="category-icon">{icon}</div>
                <span class="category-title">{escape(category)}</span>
                <span class="category-count">{len(files)} files</span>
              </div>
              <ul>
                {items}
              </ul>
            </div>
            """)

          final_html = template.replace(
            '<div id="categories">',
            '<div id="categories">\n' + "\n".join(blocks)
          )

          with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
            f.write(final_html)
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
