<!DOCTYPE html>
<!-- by ImPot8o - github.com/ImPot8o -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Code Editor</title>
    <link id="prism-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --accent: #4CAF50;
            --text-primary: #d4d4d4;
            --text-secondary: #858585;
            --error: #ff5555;
            --editor-padding: 15px;
            --line-number-width: 40px;
            --editor-font-size: 14px;
            --line-height: 1.4;
            --tab-size: 4;
            
            /* Themeable Components */
            --btn-bg: #3a3a3a;
            --btn-hover-bg: #4a4a4a;
            --file-item-text: #ffffff;
            --file-item-bg-hover: #3a3a3a;
            --status-bar-border: #333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-variant-ligatures: none;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: auto;
        }

        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--status-bar-border);
            width: 280px;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .file-tree {
            padding: 10px;
            overflow-y: auto;
        }

        .file-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--file-item-text) !important;
        }

        .file-item:hover {
            background: var(--file-item-bg-hover);
        }

        .file-item.active {
            background: var(--accent);
            color: white;
        }

        /* Dark Theme (Default) */
        .theme-dark {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --text-primary: #d4d4d4;
            --text-secondary: #858585;
            --btn-bg: #3a3a3a;
            --btn-hover-bg: #4a4a4a;
            --file-item-text: #ffffff;
            --file-item-bg-hover: #3a3a3a;
            --status-bar-border: #333;
        }

        /* Light Theme */
        .theme-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --btn-bg: #e0e0e0;
            --btn-hover-bg: #d0d0d0;
            --file-item-text: #2c2c2c;
            --file-item-bg-hover: #e0e0e0;
            --status-bar-border: #ccc;
        }

        /* Solarized Theme */
        .theme-solarized {
            --bg-primary: #002b36;
            --bg-secondary: #073642;
            --text-primary: #839496;
            --text-secondary: #586e75;
            --btn-bg: #0a5866;
            --btn-hover-bg: #0d6979;
            --file-item-text: #93a1a1;
            --file-item-bg-hover: #0a5866;
            --status-bar-border: #586e75;
        }

        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--status-bar-border);
            flex-wrap: wrap;
            z-index: 100;
        }
        .edit-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 12px;
            background: var(--btn-bg);
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--btn-hover-bg);
        }

        .editor-wrapper {
            top: 50px;
            bottom: 50px;
            flex: 1;
            display: flex;
            overflow: auto;
            position: relative;
        }

        #line-numbers {
            width: var(--line-number-width);
            padding: var(--editor-padding) 5px;
            font-family: 'Fira Code', monospace;
            color: var(--text-secondary);
            text-align: right;
            user-select: none;
            line-height: var(--line-height);
            font-size: var(--editor-font-size);
            flex-shrink: 0;
            color: #a0a0a0
        }

        .code-container {
            flex-grow: 1;
            position: relative;
        }

        .highlighted {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: var(--editor-padding);
            padding-left: 15px;
            pointer-events: none;
            z-index: 1;
            font-family: 'Fira Code', monospace;
            font-size: var(--editor-font-size);
            line-height: var(--line-height);
            tab-size: var(--tab-size);
            white-space: pre-wrap !important;
            overflow-wrap: break-word;
            inline-size: max-content;
        }

        #editor {
            position: relative;
            z-index: 2;
            color: transparent;
            caret-color: var(--text-primary);
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            inline-size: max-content;
            min-width: 100vw;
            height: 100vh;
            padding: var(--editor-padding);
            padding-left: 15px;
            font-family: 'Fira Code', monospace;
            font-size: var(--editor-font-size);
            line-height: var(--line-height);
            tab-size: var(--tab-size);
            white-space: nowrap;
            overflow-wrap: none;
            -webkit-overflow-scrolling: touch;
        }

        #preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border: none;
            background: white;
            z-index: 100;
        }

        #tab-btn {
            background: var(--accent);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }

        .settings-modal h2 {
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .setting-input {
            width: 100%;
            padding: 8px;
            background: var(--btn-bg);
            border: 1px solid var(--status-bar-border);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .theme-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .theme-option {
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            background: var(--bg-primary);
            border: 2px solid var(--text-secondary);
        }

        .theme-option.selected {
            border-color: var(--accent);
        }

        .theme-option[data-theme="dark"] { 
            background: #1e1e1e;
            border-color: #4CAF50 !important; 
        }
        .theme-option[data-theme="light"] { 
            background: #f5f5f5;
            border-color: #666 !important;
        }
        .theme-option[data-theme="solarized"] { 
            background: #002b36;
            border-color: #839496 !important;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .status-bar {
            padding: 8px 15px;
            background: var(--bg-secondary);
            border-top: 1px solid;
            border-top-color: var(--status-bar-border);
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            z-index: 100;
            bottom: 0vh;
            position: fixed;
            width: 100vw;
            /*max-width: 100vw;
            white-space: nowrap;
            overflow: hidden;*/
        }


        .scrollfix {
            position: fixed;
            width: 100vw;
        } 

        .error-line {
            color: var(--error);
            margin-left: 5px;
        }

        #file-input {
            display: none;
        }

        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                width: 80%;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }

            .sidebar-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar.active + .sidebar-backdrop {
                display: block;
            }

            .settings-modal {
                padding: 15px;
            }

            .btn span {
                display: none;
            }

            :root {
                --editor-padding: 10px;
                --line-number-width: 35px;
            }
        }
        pre[class*="language-"] {
            background: var(--bg-primary) !important;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <input type="file" id="file-input">
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-overlay"></div>
    <div class="settings-modal" id="settings-modal">
        <h2>Editor Settings</h2>
        
        <div class="setting-group">
            <label class="setting-label">Font Size</label>
            <input type="range" class="setting-input" id="font-size" min="12" max="24" step="1">
            <span id="font-size-value" class="setting-value"></span>
        </div>

        <div class="setting-group">
            <label class="setting-label">Theme</label>
            <div class="theme-select">
                <div class="theme-option dark-theme selected" data-theme="dark"></div>
                <div class="theme-option light-theme" data-theme="light"></div>
                <div class="theme-option solarized-theme" data-theme="solarized"></div>
            </div>
        </div>

        <div class="setting-group">
            <label class="setting-label">Line Height</label>
            <input type="range" class="setting-input" id="line-height" min="1.2" max="2.4" step="0.1">
            <span id="line-height-value" class="setting-value"></span>
        </div>

        <div class="setting-group">
            <label class="setting-label">Tab Size</label>
            <input type="number" class="setting-input" id="tab-size" min="2" max="8" step="1">
        </div>

        <div class="setting-group">
            <label class="setting-label">
                <input type="checkbox" id="show-line-numbers" checked>
                Show Line Numbers
            </label>
        </div>

        <button class="btn" style="margin-top: 1rem;" onclick="closeSettings()">
            <i class="fas fa-times"></i>
            Close
        </button>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-backdrop" style="display: none;"></div>
            <div class="toolbar">
                <button class="btn" id="new-btn">
                    <i class="fas fa-plus"></i>
                    <span>New</span>
                </button>
                <button class="btn" id="upload-btn">
                    <i class="fas fa-upload"></i>
                    <span>Upload</span>
                </button>
                <button class="btn" id="settings-btn" onclick="openSettings()">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </div>
            <div class="file-tree" id="file-tree"></div>
        </div>

        <div class="editor-area">
            <div class="toolbar scrollfix">
                <button class="btn" id="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="btn" id="save-btn">
                    <i class="fas fa-save"></i>
                    <span>Save</span>
                </button>
                <button class="btn" id="preview-btn">
                    <i class="fas fa-eye"></i>
                    <span>Preview</span>
                </button>
                <div class="edit-actions">
                    <button class="btn" id="tab-btn" title="Indent selection">
                        <i class="fas fa-indent"></i>
                    </button>
                    <button class="btn" id="undo-btn">
                        <i class="fas fa-undo"></i>
                        <span>Undo</span>
                    </button>
                    <button class="btn" id="redo-btn">
                        <i class="fas fa-redo"></i>
                        <span>Redo</span>
                    </button>
                </div>
            </div>
            <div class="editor-wrapper" style="margin-bottom:75px;">
                <div id="line-numbers"></div>
                <div class="code-container">
                    <pre class="highlighted" id="highlighted"></pre>
                    <pre id="editor" contenteditable="true" spellcheck="false"></pre>
                </div>
                <iframe id="preview"></iframe>
            </div>

            <div class="status-bar">
                <span id="cursor-position">Ln 1, Col 1</span>
                <span id="file-info">index.html</span>
                <span id="error-count"></span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-html.min.js"></script>
    <script>

        const editor = document.getElementById('editor');
        const highlighted = document.getElementById('highlighted');
        const lineNumbers = document.getElementById('line-numbers');
        const fileTree = document.getElementById('file-tree');
        const fileInput = document.getElementById('file-input');
        const initialContent = `<!DOCTYPE html>\n<html>\n<head>\n  <title>Document</title>\n</head>\n<body>\n  Hello World!\n<script>\n  console.log('Hello World!');\n<\/script>\n</body>\n</html>`;

        let state = {
            files: {
                'index.html': initialContent
            },
            currentFile: 'index.html',
            undoStack: {
                'index.html': [initialContent]
            },
            redoStack: {
                'index.html': []
            },
            errors: []
        };

        function init() {
            updateFileTree();
            editor.textContent = initialContent;
            editor.style.whiteSpace = 'pre-wrap';
            editor.spellcheck = false;
            editor.tabIndex = 0;
            updateAll();
            setupEventListeners();
            applySavedSettings();
            handleInput();
        }
        
        function setupEventListeners() {
            editor.addEventListener('input', handleInput);
            editor.addEventListener('keydown', handleKeyDown);
            editor.addEventListener('click', updateCursorPosition);
            
            document.getElementById('new-btn').onclick = createNewFile;
            document.getElementById('save-btn').onclick = saveFile;
            document.getElementById('preview-btn').onclick = togglePreview;
            document.getElementById('menu-btn').onclick = toggleSidebar;
            document.getElementById('undo-btn').onclick = undo;
            document.getElementById('redo-btn').onclick = redo;
            document.getElementById('upload-btn').onclick = () => fileInput.click();
            document.getElementById('tab-btn').addEventListener('click', handleTab);
            
            document.addEventListener('selectionchange', updateCursorPosition);
            document.addEventListener('click', closeSidebarOnOutsideClick);
            
            fileInput.addEventListener('change', handleFileUpload);

        }

        function getLineNumber(offset) {
            const content = editor.textContent.slice(0, offset);
            return (content.match(/\n/g) || []).length;
        }

        function handleInput() {
            const currentContent = editor.innerText;
            state.files[state.currentFile] = currentContent;
            saveState();
            updateAll();
        }
 
        function handleTab(e) {
            e.preventDefault();
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
 
            // Save current selection
            const range = selection.getRangeAt(0);
            const startOffset = range.startOffset;
            const endOffset = range.endOffset;
 
            const content = editor.innerText;
            const startLine = getLineNumber(range.startOffset);
            const endLine = getLineNumber(range.endOffset);
            
            // Modify lines
            const lines = content.split('\n');
            const tabSize = parseInt(localStorage.getItem('tabSize')) || 4;
            const indent = ' '.repeat(tabSize);
            
            const modifiedLines = lines.map((line, index) => {
                if (index >= startLine && index <= endLine) {
                    return indent + line;
                }
                return line;
            });
            
            // Update content
            const newContent = modifiedLines.join('\n');
            editor.textContent = newContent;
 
            // Update state and save
            state.files[state.currentFile] = newContent;
            saveState();
            
            // Restore selection
            const newRange = document.createRange();
            const textNode = editor.firstChild || document.createTextNode('');
            newRange.setStart(textNode, startOffset + (startLine === endLine ? tabSize : 0));
            newRange.setEnd(textNode, endOffset + (endLine - startLine + 1) * tabSize);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            updateAll();
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.execCommand('insertText', false, '\n');
            }
            if (e.key === 'Tab') {
                e.preventDefault();
                handleTab(e);
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        }

        function handleThemeChange(e) {
            const theme = e.target.dataset.theme;
            // Update document class
            document.documentElement.className = `theme-${theme}`;
            
            // Update selected state
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('selected');
            });
            e.target.classList.add('selected');
            
            // Save immediately
            localStorage.setItem('theme', theme);
            applySavedSettings();
        }


        function updateAll() {
            updateHighlighting();
            validateHTML();
            updateLineNumbers();
            updateCursorPosition();
            updateFileInfo();
        }

        function updateHighlighting() {
            const content = editor.innerText;
            highlighted.innerHTML = Prism.highlight(
                content, 
                Prism.languages.html, 
                'html'
            );
            highlighted.style.display = 'none';
            highlighted.offsetHeight;
            highlighted.style.display = 'block';
        }

        function updateLineNumbers() {
            const content = editor.innerText;
            const lines = content.split('\n');
            lineNumbers.innerHTML = lines.map((_, i) => 
                `<div>${i + 1}${state.errors.some(e => e.line === i + 1) ? '<span class="error-line">⚠</span>' : ''}</div>`
            ).join('');
        }

        function updateCursorPosition() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const offset = getTextOffset(range.startContainer, range.startOffset);
            const content = editor.textContent;
            const textUpToCursor = content.slice(0, offset);
            const lineNum = textUpToCursor.split('\n').length;
            const lineStart = textUpToCursor.lastIndexOf('\n') + 1;
            const colNum = offset - lineStart + 1;

            document.getElementById('cursor-position').textContent = 
                `Ln ${lineNum}, Col ${colNum}`;
        }

        function getTextOffset(node, offset) {
            const range = document.createRange();
            range.setStart(editor, 0);
            range.setEnd(node, offset);
            return range.toString().length;
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'block';
            document.getElementById('settings-overlay').style.display = 'block';
            loadCurrentSettings();
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('settings-overlay').style.display = 'none';
            saveSettings();
        }

        function loadCurrentSettings() {
            document.getElementById('font-size').value = 
                parseInt(getComputedStyle(document.documentElement)
                .getPropertyValue('--editor-font-size'));
            document.getElementById('font-size-value').textContent = 
                document.getElementById('font-size').value + 'px';

            document.getElementById('line-height').value = 
                parseFloat(getComputedStyle(document.documentElement)
                .getPropertyValue('--line-height'));
            document.getElementById('line-height-value').textContent = 
                document.getElementById('line-height').value;

            document.getElementById('tab-size').value = 
                parseInt(getComputedStyle(document.documentElement)
                .getPropertyValue('--tab-size'));

            document.getElementById('show-line-numbers').checked = 
                localStorage.getItem('showLineNumbers') !== 'false';

            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('selected');
                if(option.dataset.theme === (localStorage.getItem('theme') || 'dark')) {
                    option.classList.add('selected');
                }
            });
        }

        function saveSettings() {
            // Save theme
            const theme = document.querySelector('.theme-option.selected').dataset.theme;
            localStorage.setItem('theme', theme);

            // Save other settings
            localStorage.setItem('fontSize', document.getElementById('font-size').value);
            localStorage.setItem('lineHeight', document.getElementById('line-height').value);
            localStorage.setItem('tabSize', document.getElementById('tab-size').value);
            localStorage.setItem('showLineNumbers', document.getElementById('show-line-numbers').checked);

            // Apply changes immediately
            applySavedSettings();
        }

        function applySavedSettings() {
            // 1. Apply theme first
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.className = `theme-${savedTheme}`;

            // 2. Update theme selector UI
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('selected');
                if(option.dataset.theme === savedTheme) {
                    option.classList.add('selected');
                }
            });

            // 3. Font size
            const fontSize = localStorage.getItem('fontSize') || 14;
            document.documentElement.style.setProperty('--editor-font-size', `${fontSize}px`);
            editor.style.fontSize = `${fontSize}px`;
            highlighted.style.fontSize = `${fontSize}px`;

            // 4. Line height
            const lineHeight = localStorage.getItem('lineHeight') || 1.4;
            document.documentElement.style.setProperty('--line-height', lineHeight);
            editor.style.lineHeight = lineHeight;
            highlighted.style.lineHeight = lineHeight;

            // 5. Tab size
            const tabSize = localStorage.getItem('tabSize') || 4;
            document.documentElement.style.setProperty('--tab-size', tabSize);
            editor.style.tabSize = tabSize;
            highlighted.style.tabSize = tabSize;

            // 6. Line numbers visibility
            const showLineNumbers = localStorage.getItem('showLineNumbers') !== 'false';
            lineNumbers.style.display = showLineNumbers ? 'block' : 'none';

            // 7. Force redraw for syntax highlighting
            highlighted.style.display = 'none';
            highlighted.offsetHeight; // Trigger reflow
            highlighted.style.display = 'block';

            // 8. Update Prism theme
            const prismThemes = {
                'dark': 'prism-okaidia',
                'light': 'prism',
                'solarized': 'prism-solarized-dark-atom'
            };

            const prismTheme = prismThemes[savedTheme] || 'prism-okaidia';

            const existingPrismTheme = document.querySelector('#prism-theme');
            if (existingPrismTheme) existingPrismTheme.remove();

            const link = document.createElement('link');
            link.id = 'prism-theme';
            link.rel = 'stylesheet';
            link.href = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/${prismTheme}.min.css`;
            
            link.onload = () => updateHighlighting();
            link.onerror = () => {
                console.error('Failed to load Prism theme');
                updateHighlighting();
            };
    
            document.head.appendChild(link);
        }

        function validateHTML() {
            const content = editor.innerText;
            const errors = [];
            const stack = [];
            const tagRegex = /<\/?([\w-]+)/g;
            let match;
            const lines = content.split('\n');
            
            while ((match = tagRegex.exec(content)) !== null) {
                const tag = match[1].toLowerCase();
                const line = content.substr(0, match.index).split('\n').length;
                
                if (match[0].startsWith('</')) {
                    if (stack.pop() !== tag) {
                        errors.push({ 
                            pos: match.index, 
                            message: `Mismatched closing tag: ${tag}`,
                            line: line
                        });
                    }
                } else if (!isSelfClosing(tag)) {
                    stack.push(tag);
                }
            }

            if (stack.length > 0) {
                errors.push({ 
                    pos: content.length - 1, 
                    message: `Unclosed tags: ${stack.join(', ')}`,
                    line: lines.length
                });
            }

            state.errors = errors;
            document.getElementById('error-count').textContent = 
                errors.length ? `${errors.length} error(s)` : '';
        }
 
        async function saveFile() {
          const content = state.files[state.currentFile];
          let filename = state.currentFile || "untitled";
          if (!filename) return;
          if (!filename.endsWith(".html")) filename += ".html";
        
          const blob = new Blob([content], { type: "text/html" });
        
          // 1️⃣ Try File System Access API first
          if ('showSaveFilePicker' in window) {
            try {
              const handle = await window.showSaveFilePicker({
                suggestedName: filename,
                types: [
                  {
                    description: "HTML Files",
                    accept: { "text/html": [".html"] },
                  },
                ],
              });
              const writable = await handle.createWritable();
              await writable.write(blob);
              await writable.close();
              console.log("File saved using File System Access API.");
              return;
            } catch (err) {
              console.warn("File System Access API failed:", err);
              return;
              // Continue to next fallback
            }
          } else {
            console.warn("File System Access API not supported.");
          }
        
          // 2️⃣ Fallback to regular download
          try {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("File saved via regular download fallback.");
            return;
          } catch (err) {
            console.warn("Regular download fallback failed:", err);
          }
        
          // 3️⃣ Final fallback: Web Share API
          try {
            const file = new File([blob], filename, { type: "text/html" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({ files: [file], title: filename });
              console.log("File shared successfully via Web Share API.");
              return;
            } else {
              throw new Error("Web Share API not supported or cannot share files.");
            }
          } catch (err) {
            console.error("All save methods failed:", err);
            alert("Unable to save or share the file on this device.");
          }
        }

        function createNewFile() {
            let fileName = prompt("Enter a name for your new file:", `file${Object.keys(state.files).length + 1}.html`);
            
            if (!fileName) {
                // User cancelled or left it blank
                return;
            }
         
            // Add .html if not already present
            if (!fileName.toLowerCase().endsWith(".html")) {
                fileName += ".html";
            }
         
            // Prevent overwriting existing files
            if (state.files[fileName]) {
                alert("A file with that name already exists. Please choose a different name.");
                return;
            }
         
            state.files[fileName] = initialContent;
            state.undoStack[fileName] = [initialContent];
            state.redoStack[fileName] = [];
            openFile(fileName);
            updateFileTree();
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const content = await file.text();
            state.files[file.name] = content;
            state.undoStack[file.name] = [content];
            state.redoStack[file.name] = [];
            openFile(file.name);
            updateFileTree();
            fileInput.value = '';
        }

        function openFile(filename) {
            state.currentFile = filename;
            editor.textContent = state.files[filename];
            updateAll();
            updateFileTree();
            editor.focus();
        }

        function updateFileTree() {
            fileTree.innerHTML = Object.keys(state.files)
                .map(name => `
                    <div class="file-item ${name === state.currentFile ? 'active' : ''}"
                         onclick="openFile('${name}')">
                        <i class="fas fa-file-code"></i>
                        ${name}
                    </div>
                `).join('');
        }

        function updateFileInfo() {
            const maxChars = 20; // adjust max chars as needed
            const fileInfo = state.currentFile.length > maxChars ? state.currentFile.slice(0, maxChars) + '...html' : state.currentFile;
            document.getElementById('file-info').textContent = fileInfo;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
            
            // Handle backdrop
            const backdrop = document.querySelector('.sidebar-backdrop');
            if (sidebar.classList.contains('active') && !backdrop) {
                const newBackdrop = document.createElement('div');
                newBackdrop.className = 'sidebar-backdrop';
                newBackdrop.onclick = toggleSidebar;
                document.body.appendChild(newBackdrop);
            } else if (backdrop) {
                backdrop.remove();
            }
        }

        function closeSidebarOnOutsideClick(e) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active') && 
                !e.target.closest('.sidebar') &&
                !e.target.closest('#menu-btn')) {
                sidebar.classList.remove('active');
            }
        }

        function togglePreview() {
            const editorContent = editor.innerText;
            localStorage.setItem('codeBackup', editorContent);
         
            // Add debug console
            const extraCode = `
                <div id="console" style="position:fixed;top:0;left:0;width:100%;height:200px;background:#000;color:#0f0;font-family:monospace;font-size:12px;overflow-y:scroll;z-index:9999;padding:10px;border-top:2px solid #333;"><div style="position:absolute;top:5px;right:10px;"><button onclick="document.getElementById('console').style.display='none';if(!document.getElementById('showConsole')){let btn=document.createElement('button');btn.id='showConsole';btn.innerHTML='CONSOLE';btn.onclick=function(){document.getElementById('console').style.display='block';this.remove();};btn.style.cssText='position:fixed;bottom:10px;right:10px;background:#333;color:#0f0;border:1px solid #0f0;padding:5px 10px;font-size:10px;cursor:pointer;z-index:10000;border-radius:3px;';document.body.appendChild(btn);}" style="background:#333;color:#0f0;border:1px solid #0f0;padding:2px 8px;font-size:10px;cursor:pointer;">HIDE</button> <button onclick="document.getElementById('consoleOutput').innerHTML='';window.consoleHistory=[];window.historyIndex=-1;" style="background:#333;color:#0f0;border:1px solid #0f0;padding:2px 8px;font-size:10px;cursor:pointer;">CLEAR</button> <button onclick="toggleConsolePosition()" style="background:#333;color:#0f0;border:1px solid #0f0;padding:2px 8px;font-size:10px;cursor:pointer;">TOGGLE</button></div><div id="consoleOutput" style="margin-top:25px;height:120px;overflow-y:scroll;"></div><div style="position:absolute;bottom:5px;left:10px;right:10px;display:flex;gap:2px;"><button onclick="let h=window.consoleHistory||[];let i=window.historyIndex||0;if(i<h.length-1){window.historyIndex=++i;document.getElementById('jsInput').value=h[h.length-1-i]||'';}" style="background:#333;color:#0f0;border:1px solid #0f0;padding:5px;font-size:10px;width:25px;">↑</button><input id="jsInput" placeholder="Enter JavaScript..." style="flex:1;background:#111;color:#0f0;border:1px solid #333;padding:5px;font-family:monospace;font-size:12px;" onkeypress="if(event.key==='Enter'){let cmd=this.value;if(cmd.trim()){window.consoleHistory=window.consoleHistory||[];window.consoleHistory.push(cmd);window.historyIndex=-1;}try{console.log('> '+cmd);let result=eval(cmd);if(result!==undefined){if(typeof result==='object'){console.log(JSON.stringify(result,null,2));}else{console.log(result);}}this.value='';}catch(e){console.log('ERROR: '+e.message);this.value='';}}"><button onclick="let h=window.consoleHistory||[];let i=window.historyIndex||0;if(i>-1){window.historyIndex=--i;document.getElementById('jsInput').value=h[h.length-1-i]||'';}" style="background:#333;color:#0f0;border:1px solid #0f0;padding:5px;font-size:10px;width:25px;">↓</button><button onclick="let input=document.getElementById('jsInput');let cmd=input.value;if(cmd.trim()){window.consoleHistory=window.consoleHistory||[];window.consoleHistory.push(cmd);window.historyIndex=-1;}try{console.log('> '+cmd);let result=eval(cmd);if(result!==undefined){if(typeof result==='object'){console.log(JSON.stringify(result,null,2));}else{console.log(result);}}input.value='';}catch(e){console.log('ERROR: '+e.message);input.value='';}" style="background:#333;color:#0f0;border:1px solid #0f0;padding:5px;font-size:10px;width:30px;">RUN</button></div></div><script>window.onerror=function(msg, url, line, col, error) {const consoleOutput=document.getElementById('consoleOutput');consoleOutput.innerHTML +='<span style="color:#f44">ERROR: ' + msg + ' (Line ' + line + ')</span><br>';consoleOutput.scrollTop=consoleOutput.scrollHeight;};function safeInspect(value, depth=0, seen=new WeakSet()) {if (value===null) return 'null';if (value===undefined) return 'undefined';if (typeof value==='function') return 'function ' + (value.name || '(anonymous)') + '()';if (typeof value !=='object') return JSON.stringify(value);if (seen.has(value)) return '[Circular]';seen.add(value);if (depth > 2) return '[Object]';const entries=Object.entries(value).slice(0, 20).map(([k, v])=> `+'`'+'${k}: ${safeInspect(v, depth + 1, seen)}'+'`'+`).join(', ');return `+'`'+'{ ${entries} }'+'`'+`;}console.log=function(...args) {const output=args.map(arg=> {try {return '<pre style="display:inline;color:#0f0;">' + safeInspect(arg) + '</pre>';} catch (err) {return '<span style="color:#f44;">[Unserializable: ' + err.message + ']</span>';}}).join(' ');const timestamp=new Date().toLocaleTimeString();const consoleOutput=document.getElementById('consoleOutput');consoleOutput.innerHTML +=`+'`'+'<span style="color:#666">[${timestamp}]</span> ${output}<br>'+'`'+';consoleOutput.scrollTop=consoleOutput.scrollHeight;};window.consoleHistory=[];window.historyIndex=-1;function toggleConsolePosition() {const consoleEl=document.getElementById("console");if (consoleEl.style.top==="0px") {consoleEl.style.top="auto";consoleEl.style.bottom="0";} else {consoleEl.style.top="0" ;consoleEl.style.bottom="auto";}}'+`<\/script>
            `;
            const modifiedContent = editorContent.replace(
                /<body([^>]*)>/i,
                `<body$1>${extraCode}`
            );
            const newTab = window.open('about:blank', '_blank');
            newTab.document.open();
            newTab.document.write(modifiedContent);
            newTab.document.close();
        }

        function saveState() {
            const currentContent = state.files[state.currentFile];
            const undoStack = state.undoStack[state.currentFile];
            if (undoStack[undoStack.length - 1] !== currentContent) {
                undoStack.push(currentContent);
                state.redoStack[state.currentFile] = [];
            }
        }

        function undo() {
            if (state.undoStack[state.currentFile].length > 1) {
                state.redoStack[state.currentFile].push(
                    state.undoStack[state.currentFile].pop()
                );
                state.files[state.currentFile] = state.undoStack[state.currentFile].slice(-1)[0];
                editor.textContent = state.files[state.currentFile];
                updateAll();
            }
        }

        function redo() {
            if (state.redoStack[state.currentFile].length > 0) {
                state.files[state.currentFile] = state.redoStack[state.currentFile].pop();
                state.undoStack[state.currentFile].push(state.files[state.currentFile]);
                editor.textContent = state.files[state.currentFile];
                updateAll();
            }
        }

        function isSelfClosing(tag) {
            const selfClosing = ['img', 'br', 'hr', 'meta', 'link', 'input'];
            return selfClosing.includes(tag.toLowerCase());
        }

        init();
    </script>
</body>
</html>