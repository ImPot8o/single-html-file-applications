<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pro Mobile DAW Studio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            overflow-x: hidden;
            height: 100vh;
            touch-action: manipulation;
        }

        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 2000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .header-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.2);
        }

        .header-btn.active {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.3);
        }

        .main-container {
            padding-top: 65px;
            padding-bottom: 90px;
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .transport-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 0 15px;
            z-index: 2000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.5);
        }

        .transport-btn {
            width: 55px;
            height: 55px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            position: relative;
        }

        .transport-btn:active {
            transform: scale(0.85);
        }

        .transport-btn.active {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            box-shadow: 0 6px 25px rgba(0, 245, 255, 0.6);
            animation: pulse 2s infinite;
        }

        .transport-btn.record {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.4);
        }

        .transport-btn.record.active {
            animation: recordPulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        @keyframes recordPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .time-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            border-radius: 25px;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 1.1rem;
            color: #00f5ff;
            min-width: 90px;
            text-align: center;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .window {
            display: none;
            position: fixed;
            top: 65px;
            left: 0;
            right: 0;
            bottom: 90px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            z-index: 1500;
            overflow-y: auto;
            padding: 20px;
        }

        .window.active {
            display: block;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .window-title {
            font-size: 1.4rem;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-btn:active {
            background: rgba(255, 65, 108, 0.3);
            transform: scale(0.9);
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .track:active {
            transform: scale(0.98);
        }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .track-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .track-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .track-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .track-type {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        .track-controls {
            display: flex;
            gap: 8px;
        }

        .track-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .track-btn:active {
            transform: scale(0.85);
        }

        .track-btn.active {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.3);
        }

        .track-btn.record {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }

        .track-btn.delete {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }

        .waveform {
            height: 80px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 245, 255, 0.2);
        }

        .waveform-canvas {
            width: 100%;
            height: 100%;
        }

        .waveform-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.6;
            font-size: 0.9rem;
            color: #00f5ff;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 12px;
        }

        .slider-label {
            min-width: 60px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #00f5ff;
        }

        .slider {
            flex: 1;
            height: 35px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            outline: none;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.4);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        .slider-value {
            min-width: 50px;
            text-align: right;
            font-size: 0.9rem;
            color: #00f5ff;
            font-weight: 600;
            font-family: monospace;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }

        .tool-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .tool-card:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.1);
        }

        .tool-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tool-card h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .tool-card p {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            height: 140px;
            margin: 25px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .key {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border: 1px solid #adb5bd;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s ease;
            font-size: 1rem;
        }

        .key:active, .key.playing {
            background: linear-gradient(to bottom, #00f5ff, #0077ff);
            color: white;
            transform: scale(0.95);
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .key.black {
            background: linear-gradient(to bottom, #495057, #212529);
            color: white;
            height: 90px;
            margin: 0 -8px;
            z-index: 2;
            border-radius: 0 0 8px 8px;
        }

        .key.black:active, .key.black.playing {
            background: linear-gradient(to bottom, #ff00ff, #cc00cc);
        }

        .drum-pads {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }

        .drum-pad {
            aspect-ratio: 1;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .drum-pad:active, .drum-pad.playing {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            transform: scale(0.9);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.6);
        }

        .sequencer {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .step {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step:active {
            transform: scale(0.85);
        }

        .step.active {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border-color: #ff416c;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
        }

        .step.playing {
            background: linear-gradient(45deg, #00f5ff, #0077ff);
            border-color: #00f5ff;
            animation: stepPulse 0.3s ease;
        }

        @keyframes stepPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.success {
            background: linear-gradient(45deg, #2ed573, #1dd1a1);
            box-shadow: 0 6px 20px rgba(46, 213, 115, 0.3);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.3);
        }

        .btn.premium {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            box-shadow: 0 6px 20px rgba(0, 245, 255, 0.4);
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .upload-area {
            border: 3px dashed rgba(0, 245, 255, 0.4);
            border-radius: 20px;
            padding: 50px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 25px 0;
            background: rgba(0, 245, 255, 0.05);
        }

        .upload-area:active {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.1);
            transform: scale(0.98);
        }

        .upload-area i {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tuner-display {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .tuner-note {
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .tuner-cents {
            font-size: 1.3rem;
            margin-bottom: 25px;
            color: #00f5ff;
        }

        .tuner-meter {
            position: relative;
            height: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 25px 0;
            overflow: hidden;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .tuner-pointer {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            transition: left 0.3s ease;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.6);
        }

        .recording-indicator {
            position: fixed;
            top: 75px;
            right: 15px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 2001;
            animation: recordPulse 1s infinite;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
        }

        .recording-indicator.active {
            display: flex;
        }

        .status-text {
            position: fixed;
            top: 75px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: #00f5ff;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 2001;
            max-width: calc(100vw - 180px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .fab {
            position: fixed;
            bottom: 110px;
            right: 20px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(45deg, #2ed573, #1dd1a1);
            border: none;
            color: white;
            font-size: 1.6rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(46, 213, 115, 0.5);
            z-index: 1999;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fab:active {
            transform: scale(0.85);
        }

        .spectrum-canvas {
            width: 100%;
            height: 120px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.4);
            margin: 20px 0;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .eq-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 25px 0;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .eq-band {
            text-align: center;
        }

        .eq-band label {
            display: block;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
            color: #00f5ff;
        }

        .eq-slider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 35px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 20px;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .effects-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .effect-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .effect-card.active {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.2);
        }

        .effect-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .effect-name {
            font-weight: 600;
            color: #00f5ff;
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        .vu-meter {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .vu-level {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #ffa502, #ff416c);
            border-radius: 10px;
            transition: width 0.1s ease;
            width: 0%;
        }

        .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #00f5ff;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 245, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pro-feature {
            position: relative;
        }

        .pro-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(45deg, #ff00ff, #00f5ff);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
        }

        .mixer-channel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .channel-name {
            font-weight: 600;
            color: #00f5ff;
        }

        .channel-controls {
            display: flex;
            gap: 8px;
        }

        .automation-lane {
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 10px 0;
            position: relative;
            border: 1px solid rgba(0, 245, 255, 0.2);
        }

        .automation-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #00f5ff;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 245, 255, 0.4);
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #00f5ff, #ff00ff);
            border-radius: 2px;
            transition: width 0.1s linear;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 480px) {
            .tool-grid {
                grid-template-columns: 1fr;
            }
            
            .keyboard {
                height: 120px;
            }
            
            .drum-pads {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sequencer {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .eq-controls {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 360px) {
            .header-controls {
                gap: 5px;
            }
            
            .header-btn {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }
            
            .transport-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="logo">
            <i class="fas fa-waveform-lines"></i> Pro DAW
        </div>
        <div class="header-controls">
            <button class="header-btn" id="menuBtn" onclick="toggleWindow('menu')">
                <i class="fas fa-th"></i>
            </button>
            <button class="header-btn" id="mixerBtn" onclick="toggleWindow('mixer')">
                <i class="fas fa-sliders-h"></i>
            </button>
            <button class="header-btn" id="settingsBtn" onclick="toggleWindow('settings')">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- Status Display -->
    <div class="status-text" id="statusText">Pro DAW Studio Ready</div>

    <!-- Recording Indicator -->
    <div class="recording-indicator" id="recordingIndicator">
        <i class="fas fa-circle"></i>
        <span>REC</span>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tracks Window (Default) -->
        <div class="window active" id="tracksWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-list"></i> Tracks
                </div>
                <button class="close-btn" onclick="closeAllWindows()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="track-list" id="trackList">
                <!-- Tracks will be added here -->
            </div>
        </div>

        <!-- Menu Window -->
        <div class="window" id="menuWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-th"></i> Studio Tools
                </div>
                <button class="close-btn" onclick="closeWindow('menu')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-music"></i> Instruments
            </div>
            <div class="tool-grid">
                <div class="tool-card" onclick="openTool('synth')">
                    <i class="fas fa-piano"></i>
                    <h3>Advanced Synth</h3>
                    <p>Multi-oscillator synthesizer</p>
                </div>
                <div class="tool-card" onclick="openTool('drums')">
                    <i class="fas fa-drum"></i>
                    <h3>Drum Machine</h3>
                    <p>Professional drum sequencer</p>
                </div>
                <div class="tool-card" onclick="openTool('sampler')">
                    <i class="fas fa-compact-disc"></i>
                    <h3>Sampler</h3>
                    <p>Advanced sample manipulation</p>
                </div>
                <div class="tool-card" onclick="openTool('bass')">
                    <i class="fas fa-guitar"></i>
                    <h3>Bass Synth</h3>
                    <p>Deep bass synthesizer</p>
                </div>
            </div>

            <div class="section-header">
                <i class="fas fa-tools"></i> Utilities
            </div>
            <div class="tool-grid">
                <div class="tool-card" onclick="openTool('tuner')">
                    <i class="fas fa-guitar"></i>
                    <h3>Chromatic Tuner</h3>
                    <p>Precision instrument tuner</p>
                </div>
                <div class="tool-card" onclick="openTool('metronome')">
                    <i class="fas fa-clock"></i>
                    <h3>Metronome</h3>
                    <p>Advanced click track</p>
                </div>
                <div class="tool-card" onclick="openTool('import')">
                    <i class="fas fa-upload"></i>
                    <h3>Import Audio</h3>
                    <p>Add your audio files</p>
                </div>
                <div class="tool-card" onclick="openTool('export')">
                    <i class="fas fa-download"></i>
                    <h3>Export & Share</h3>
                    <p>Professional export options</p>
                </div>
            </div>

            <div class="section-header">
                <i class="fas fa-magic"></i> Effects & Processing
            </div>
            <div class="tool-grid">
                <div class="tool-card" onclick="openTool('effects')">
                    <i class="fas fa-magic"></i>
                    <h3>Effects Rack</h3>
                    <p>Professional audio effects</p>
                </div>
                <div class="tool-card" onclick="openTool('mastering')">
                    <i class="fas fa-compress-arrows-alt"></i>
                    <h3>Mastering Suite</h3>
                    <p>Professional mastering tools</p>
                </div>
                <div class="tool-card" onclick="openTool('vocoder')">
                    <i class="fas fa-microphone-alt"></i>
                    <h3>Vocoder</h3>
                    <p>Voice synthesis & effects</p>
                </div>
                <div class="tool-card" onclick="openTool('analyzer')">
                    <i class="fas fa-chart-line"></i>
                    <h3>Spectrum Analyzer</h3>
                    <p>Advanced audio analysis</p>
                </div>
            </div>
        </div>

        <!-- Advanced Synthesizer Window -->
        <div class="window" id="synthWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-piano"></i> Advanced Synthesizer
                </div>
                <button class="close-btn" onclick="closeTool('synth')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-wave-square"></i> Oscillators
            </div>
            
            <div class="slider-group">
                <span class="slider-label">OSC 1</span>
                <select id="synthWave1" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">OSC 2</span>
                <select id="synthWave2" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Mix</span>
                <input type="range" class="slider" id="synthMix" min="0" max="100" value="50">
                <span class="slider-value" id="synthMixVal">50%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Detune</span>
                <input type="range" class="slider" id="synthDetune" min="-50" max="50" value="0">
                <span class="slider-value" id="synthDetuneVal">0Â¢</span>
            </div>
            
            <div class="section-header">
                <i class="fas fa-filter"></i> Filter & Envelope
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Cutoff</span>
                <input type="range" class="slider" id="synthCutoff" min="100" max="8000" value="2000">
                <span class="slider-value" id="synthCutoffVal">2000Hz</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Resonance</span>
                <input type="range" class="slider" id="synthResonance" min="0" max="30" value="5">
                <span class="slider-value" id="synthResonanceVal">5</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Attack</span>
                <input type="range" class="slider" id="synthAttack" min="0" max="2" step="0.01" value="0.1">
                <span class="slider-value" id="synthAttackVal">0.1s</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Decay</span>
                <input type="range" class="slider" id="synthDecay" min="0" max="2" step="0.01" value="0.3">
                <span class="slider-value" id="synthDecayVal">0.3s</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Sustain</span>
                <input type="range" class="slider" id="synthSustain" min="0" max="1" step="0.01" value="0.7">
                <span class="slider-value" id="synthSustainVal">70%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Release</span>
                <input type="range" class="slider" id="synthRelease" min="0" max="3" step="0.01" value="0.5">
                <span class="slider-value" id="synthReleaseVal">0.5s</span>
            </div>
            
            <div class="section-header">
                <i class="fas fa-keyboard"></i> Keyboard
            </div>
            
            <div class="keyboard" id="synthKeyboard">
                <div class="key" data-note="C" data-freq="261.63">C</div>
                <div class="key black" data-note="C#" data-freq="277.18">C#</div>
                <div class="key" data-note="D" data-freq="293.66">D</div>
                <div class="key black" data-note="D#" data-freq="311.13">D#</div>
                <div class="key" data-note="E" data-freq="329.63">E</div>
                <div class="key" data-note="F" data-freq="349.23">F</div>
                <div class="key black" data-note="F#" data-freq="369.99">F#</div>
                <div class="key" data-note="G" data-freq="392.00">G</div>
                <div class="key black" data-note="G#" data-freq="415.30">G#</div>
                <div class="key" data-note="A" data-freq="440.00">A</div>
                <div class="key black" data-note="A#" data-freq="466.16">A#</div>
                <div class="key" data-note="B" data-freq="493.88">B</div>
            </div>
            
            <div class="btn-grid">
                <button class="btn success" onclick="addSynthTrack()">
                    <i class="fas fa-plus"></i> Add Track
                </button>
                <button class="btn premium" id="synthRecBtn" onclick="toggleSynthRecord()">
                    <i class="fas fa-circle"></i> Record
                </button>
            </div>
        </div>

        <!-- Professional Drum Machine Window -->
        <div class="window" id="drumsWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-drum"></i> Professional Drums
                </div>
                <button class="close-btn" onclick="closeTool('drums')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-hand-fist"></i> Drum Pads
            </div>
            
            <div class="drum-pads">
                <button class="drum-pad" data-drum="kick" onclick="playDrum('kick')">
                    <div>
                        <i class="fas fa-drum" style="display: block; margin-bottom: 5px;"></i>
                        KICK
                    </div>
                </button>
                <button class="drum-pad" data-drum="snare" onclick="playDrum('snare')">
                    <div>
                        <i class="fas fa-circle" style="display: block; margin-bottom: 5px;"></i>
                        SNARE
                    </div>
                </button>
                <button class="drum-pad" data-drum="hihat" onclick="playDrum('hihat')">
                    <div>
                        <i class="fas fa-compact-disc" style="display: block; margin-bottom: 5px;"></i>
                        HI-HAT
                    </div>
                </button>
                <button class="drum-pad" data-drum="crash" onclick="playDrum('crash')">
                    <div>
                        <i class="fas fa-star" style="display: block; margin-bottom: 5px;"></i>
                        CRASH
                    </div>
                </button>
                <button class="drum-pad" data-drum="openhat" onclick="playDrum('openhat')">
                    <div>
                        <i class="fas fa-circle-notch" style="display: block; margin-bottom: 5px;"></i>
                        OPEN HAT
                    </div>
                </button>
                <button class="drum-pad" data-drum="clap" onclick="playDrum('clap')">
                    <div>
                        <i class="fas fa-hands-clapping" style="display: block; margin-bottom: 5px;"></i>
                        CLAP
                    </div>
                </button>
                <button class="drum-pad" data-drum="perc1" onclick="playDrum('perc1')">
                    <div>
                        <i class="fas fa-music" style="display: block; margin-bottom: 5px;"></i>
                        PERC 1
                    </div>
                </button>
                <button class="drum-pad" data-drum="perc2" onclick="playDrum('perc2')">
                    <div>
                        <i class="fas fa-bell" style="display: block; margin-bottom: 5px;"></i>
                        PERC 2
                    </div>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-list-ol"></i> 16-Step Sequencer
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Pattern</span>
                <select id="drumPattern" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="0">Pattern 1</option>
                    <option value="1">Pattern 2</option>
                    <option value="2">Pattern 3</option>
                    <option value="3">Pattern 4</option>
                </select>
            </div>
            
            <div class="sequencer" id="drumSequencer">
                <!-- Steps will be generated -->
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Swing</span>
                <input type="range" class="slider" id="drumSwing" min="0" max="100" value="0">
                <span class="slider-value" id="drumSwingVal">0%</span>
            </div>
            
            <div class="btn-grid">
                <button class="btn" id="drumPlayBtn" onclick="toggleDrumPattern()">
                    <i class="fas fa-play"></i> Play
                </button>
                <button class="btn" onclick="clearDrumPattern()">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button class="btn success" onclick="addDrumTrack()">
                    <i class="fas fa-plus"></i> Add Track
                </button>
                <button class="btn premium" onclick="toggleDrumRecord()">
                    <i class="fas fa-circle"></i> Record
                </button>
            </div>
        </div>

        <!-- Bass Synthesizer Window -->
        <div class="window" id="bassWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-guitar"></i> Bass Synthesizer
                </div>
                <button class="close-btn" onclick="closeTool('bass')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-wave-square"></i> Bass Engine
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Waveform</span>
                <select id="bassWave" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="triangle">Triangle</option>
                    <option value="sine">Sine</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Sub Osc</span>
                <input type="range" class="slider" id="bassSubOsc" min="0" max="100" value="30">
                <span class="slider-value" id="bassSubOscVal">30%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Distortion</span>
                <input type="range" class="slider" id="bassDistortion" min="0" max="100" value="15">
                <span class="slider-value" id="bassDistortionVal">15%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Filter Cutoff</span>
                <input type="range" class="slider" id="bassCutoff" min="50" max="2000" value="800">
                <span class="slider-value" id="bassCutoffVal">800Hz</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Filter Res</span>
                <input type="range" class="slider" id="bassResonance" min="0" max="20" value="8">
                <span class="slider-value" id="bassResonanceVal">8</span>
            </div>
            
            <div class="keyboard" id="bassKeyboard">
                <div class="key" data-note="C" data-freq="130.81">C2</div>
                <div class="key black" data-note="C#" data-freq="138.59">C#2</div>
                <div class="key" data-note="D" data-freq="146.83">D2</div>
                <div class="key black" data-note="D#" data-freq="155.56">D#2</div>
                <div class="key" data-note="E" data-freq="164.81">E2</div>
                <div class="key" data-note="F" data-freq="174.61">F2</div>
                <div class="key black" data-note="F#" data-freq="185.00">F#2</div>
                <div class="key" data-note="G" data-freq="196.00">G2</div>
                <div class="key black" data-note="G#" data-freq="207.65">G#2</div>
                <div class="key" data-note="A" data-freq="220.00">A2</div>
                <div class="key black" data-note="A#" data-freq="233.08">A#2</div>
                <div class="key" data-note="B" data-freq="246.94">B2</div>
            </div>
            
            <div class="btn-grid">
                <button class="btn success" onclick="addBassTrack()">
                    <i class="fas fa-plus"></i> Add Track
                </button>
                <button class="btn premium" onclick="toggleBassRecord()">
                    <i class="fas fa-circle"></i> Record
                </button>
            </div>
        </div>

        <!-- Sampler Window -->
        <div class="window" id="samplerWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-compact-disc"></i> Advanced Sampler
                </div>
                <button class="close-btn" onclick="closeTool('sampler')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="upload-area" onclick="document.getElementById('samplerFileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Load Sample</h3>
                <p>Drag & drop or tap to select audio files</p>
            </div>
            <input type="file" id="samplerFileInput" accept="audio/*" style="display: none;">
            
            <div class="section-header">
                <i class="fas fa-sliders-h"></i> Sample Controls
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Start</span>
                <input type="range" class="slider" id="sampleStart" min="0" max="100" value="0">
                <span class="slider-value" id="sampleStartVal">0%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">End</span>
                <input type="range" class="slider" id="sampleEnd" min="0" max="100" value="100">
                <span class="slider-value" id="sampleEndVal">100%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Pitch</span>
                <input type="range" class="slider" id="samplePitch" min="-24" max="24" value="0">
                <span class="slider-value" id="samplePitchVal">0st</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Loop</span>
                <label style="flex: 1; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="sampleLoop" style="width: 20px; height: 20px;">
                    <span>Enable loop playback</span>
                </label>
            </div>
            
            <div class="keyboard" id="samplerKeyboard">
                <div class="key" data-note="C" data-freq="261.63">C</div>
                <div class="key black" data-note="C#" data-freq="277.18">C#</div>
                <div class="key" data-note="D" data-freq="293.66">D</div>
                <div class="key black" data-note="D#" data-freq="311.13">D#</div>
                <div class="key" data-note="E" data-freq="329.63">E</div>
                <div class="key" data-note="F" data-freq="349.23">F</div>
                <div class="key black" data-note="F#" data-freq="369.99">F#</div>
                <div class="key" data-note="G" data-freq="392.00">G</div>
                <div class="key black" data-note="G#" data-freq="415.30">G#</div>
                <div class="key" data-note="A" data-freq="440.00">A</div>
                <div class="key black" data-note="A#" data-freq="466.16">A#</div>
                <div class="key" data-note="B" data-freq="493.88">B</div>
            </div>
            
            <div class="btn-grid">
                <button class="btn" onclick="playSample()">
                    <i class="fas fa-play"></i> Play Sample
                </button>
                <button class="btn success" onclick="addSamplerTrack()">
                    <i class="fas fa-plus"></i> Add Track
                </button>
            </div>
        </div>

        <!-- Advanced Mixer Window -->
        <div class="window" id="mixerWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-sliders-h"></i> Professional Mixer
                </div>
                <button class="close-btn" onclick="closeTool('mixer')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-volume-up"></i> Master Section
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Master</span>
                <input type="range" class="slider" id="masterVolume" min="0" max="100" value="80">
                <span class="slider-value" id="masterVol">80%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">BPM</span>
                <input type="range" class="slider" id="bpmSlider" min="60" max="200" value="120">
                <span class="slider-value" id="bpmVal">120</span>
            </div>
            
            <div class="vu-meter">
                <div class="vu-level" id="masterVU"></div>
            </div>
            
            <canvas class="spectrum-canvas" id="spectrumCanvas" width="300" height="120"></canvas>
            
            <div class="section-header">
                <i class="fas fa-equalizer"></i> Master EQ
            </div>
            
            <div class="eq-controls">
                <div class="eq-band">
                    <label>Low</label>
                    <input type="range" class="eq-slider" id="eqLow" min="-12" max="12" value="0">
                    <span class="slider-value" id="eqLowVal">0dB</span>
                </div>
                <div class="eq-band">
                    <label>Low-Mid</label>
                    <input type="range" class="eq-slider" id="eqLowMid" min="-12" max="12" value="0">
                    <span class="slider-value" id="eqLowMidVal">0dB</span>
                </div>
                <div class="eq-band">
                    <label>High-Mid</label>
                    <input type="range" class="eq-slider" id="eqHighMid" min="-12" max="12" value="0">
                    <span class="slider-value" id="eqHighMidVal">0dB</span>
                </div>
                <div class="eq-band">
                    <label>High</label>
                    <input type="range" class="eq-slider" id="eqHigh" min="-12" max="12" value="0">
                    <span class="slider-value" id="eqHighVal">0dB</span>
                </div>
            </div>
            
            <div class="section-header">
                <i class="fas fa-compress"></i> Master Compressor
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Threshold</span>
                <input type="range" class="slider" id="compThreshold" min="-40" max="0" value="-12">
                <span class="slider-value" id="compThresholdVal">-12dB</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Ratio</span>
                <input type="range" class="slider" id="compRatio" min="1" max="20" value="4">
                <span class="slider-value" id="compRatioVal">4:1</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Attack</span>
                <input type="range" class="slider" id="compAttack" min="0.1" max="100" value="10">
                <span class="slider-value" id="compAttackVal">10ms</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Release</span>
                <input type="range" class="slider" id="compRelease" min="10" max="1000" value="100">
                <span class="slider-value" id="compReleaseVal">100ms</span>
            </div>
            
            <div id="mixerChannels">
                <!-- Mixer channels will be generated here -->
            </div>
        </div>

        <!-- Effects Rack Window -->
        <div class="window" id="effectsWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-magic"></i> Effects Rack
                </div>
                <button class="close-btn" onclick="closeTool('effects')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-wave-square"></i> Modulation Effects
            </div>
            
            <div class="effects-grid">
                <div class="effect-card" id="chorusCard">
                    <div class="effect-toggle">
                        <span class="effect-name">Chorus</span>
                        <div class="toggle-switch" id="chorusToggle" onclick="toggleEffect('chorus')"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Rate</span>
                        <input type="range" class="slider" id="chorusRate" min="0.1" max="10" step="0.1" value="2">
                        <span class="slider-value" id="chorusRateVal">2Hz</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Depth</span>
                        <input type="range" class="slider" id="chorusDepth" min="0" max="100" value="50">
                        <span class="slider-value" id="chorusDepthVal">50%</span>
                    </div>
                </div>
                
                <div class="effect-card" id="flangerCard">
                    <div class="effect-toggle">
                        <span class="effect-name">Flanger</span>
                        <div class="toggle-switch" id="flangerToggle" onclick="toggleEffect('flanger')"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Rate</span>
                        <input type="range" class="slider" id="flangerRate" min="0.1" max="5" step="0.1" value="0.5">
                        <span class="slider-value" id="flangerRateVal">0.5Hz</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Feedback</span>
                        <input type="range" class="slider" id="flangerFeedback" min="0" max="95" value="70">
                        <span class="slider-value" id="flangerFeedbackVal">70%</span>
                    </div>
                </div>
            </div>
            
            <div class="section-header">
                <i class="fas fa-clock"></i> Time-Based Effects
            </div>
            
            <div class="effects-grid">
                <div class="effect-card" id="delayCard">
                    <div class="effect-toggle">
                        <span class="effect-name">Delay</span>
                        <div class="toggle-switch" id="delayToggle" onclick="toggleEffect('delay')"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Time</span>
                        <input type="range" class="slider" id="delayTime" min="10" max="1000" value="250">
                        <span class="slider-value" id="delayTimeVal">250ms</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Feedback</span>
                        <input type="range" class="slider" id="delayFeedback" min="0" max="95" value="30">
                        <span class="slider-value" id="delayFeedbackVal">30%</span>
                    </div>
                </div>
                
                <div class="effect-card" id="reverbCard">
                    <div class="effect-toggle">
                        <span class="effect-name">Reverb</span>
                        <div class="toggle-switch" id="reverbToggle" onclick="toggleEffect('reverb')"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Room</span>
                        <input type="range" class="slider" id="reverbRoom" min="0" max="100" value="50">
                        <span class="slider-value" id="reverbRoomVal">50%</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Decay</span>
                        <input type="range" class="slider" id="reverbDecay" min="0.1" max="10" step="0.1" value="2">
                        <span class="slider-value" id="reverbDecayVal">2s</span>
                    </div>
                </div>
            </div>
            
            <div class="section-header">
                <i class="fas fa-fire"></i> Distortion & Dynamics
            </div>
            
            <div class="effects-grid">
                <div class="effect-card" id="distortionCard">
                    <div class="effect-toggle">
                        <span class="effect-name">Distortion</span>
                        <div class="toggle-switch" id="distortionToggle" onclick="toggleEffect('distortion')"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Drive</span>
                        <input type="range" class="slider" id="distortionDrive" min="0" max="100" value="25">
                        <span class="slider-value" id="distortionDriveVal">25%</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Tone</span>
                        <input type="range" class="slider" id="distortionTone" min="0" max="100" value="50">
                        <span class="slider-value" id="distortionToneVal">50%</span>
                    </div>
                </div>
                
                <div class="effect-card" id="bitcrusherCard">
                    <div class="effect-toggle">
                        <span class="effect-name">Bitcrusher</span>
                        <div class="toggle-switch" id="bitcrusherToggle" onclick="toggleEffect('bitcrusher')"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Bits</span>
                        <input type="range" class="slider" id="bitcrusherBits" min="1" max="16" value="8">
                        <span class="slider-value" id="bitcrusherBitsVal">8</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Rate</span>
                        <input type="range" class="slider" id="bitcrusherRate" min="1000" max="44100" value="22050">
                        <span class="slider-value" id="bitcrusherRateVal">22kHz</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mastering Suite Window -->
        <div class="window" id="masteringWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-compress-arrows-alt"></i> Mastering Suite
                </div>
                <button class="close-btn" onclick="closeTool('mastering')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-chart-line"></i> Multiband Compressor
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Low Band</span>
                <input type="range" class="slider" id="mbCompLow" min="0" max="10" value="3">
                <span class="slider-value" id="mbCompLowVal">3dB</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Mid Band</span>
                <input type="range" class="slider" id="mbCompMid" min="0" max="10" value="2">
                <span class="slider-value" id="mbCompMidVal">2dB</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">High Band</span>
                <input type="range" class="slider" id="mbCompHigh" min="0" max="10" value="1">
                <span class="slider-value" id="mbCompHighVal">1dB</span>
            </div>
            
            <div class="section-header">
                <i class="fas fa-volume-up"></i> Maximizer
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Ceiling</span>
                <input type="range" class="slider" id="maximizerCeiling" min="-3" max="0" step="0.1" value="-0.3">
                <span class="slider-value" id="maximizerCeilingVal">-0.3dB</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Release</span>
                <input type="range" class="slider" id="maximizerRelease" min="1" max="1000" value="50">
                <span class="slider-value" id="maximizerReleaseVal">50ms</span>
            </div>
            
            <div class="section-header">
                <i class="fas fa-balance-scale"></i> Stereo Imaging
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Width</span>
                <input type="range" class="slider" id="stereoWidth" min="0" max="200" value="100">
                <span class="slider-value" id="stereoWidthVal">100%</span>
            </div>
            
            <div class="btn-grid">
                <button class="btn" onclick="toggleMastering()">
                    <i class="fas fa-power-off"></i> Enable
                </button>
                <button class="btn premium" onclick="analyzeLoudness()">
                    <i class="fas fa-chart-bar"></i> Analyze
                </button>
            </div>
        </div>

        <!-- Vocoder Window -->
        <div class="window" id="vocoderWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-microphone-alt"></i> Vocoder
                </div>
                <button class="close-btn" onclick="closeTool('vocoder')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-wave-square"></i> Carrier Oscillator
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Waveform</span>
                <select id="vocoderWave" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Bands</span>
                <input type="range" class="slider" id="vocoderBands" min="8" max="32" value="16">
                <span class="slider-value" id="vocoderBandsVal">16</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Attack</span>
                <input type="range" class="slider" id="vocoderAttack" min="1" max="100" value="10">
                <span class="slider-value" id="vocoderAttackVal">10ms</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Release</span>
                <input type="range" class="slider" id="vocoderRelease" min="10" max="1000" value="100">
                <span class="slider-value" id="vocoderReleaseVal">100ms</span>
            </div>
            
            
            <div class="keyboard" id="vocoderKeyboard">
                <div class="key" data-note="C" data-freq="261.63">C</div>
                <div class="key black" data-note="C#" data-freq="277.18">C#</div>
                <div class="key" data-note="D" data-freq="293.66">D</div>
                <div class="key black" data-note="D#" data-freq="311.13">D#</div>
                <div class="key" data-note="E" data-freq="329.63">E</div>
                <div class="key" data-note="F" data-freq="349.23">F</div>
                <div class="key black" data-note="F#" data-freq="369.99">F#</div>
                <div class="key" data-note="G" data-freq="392.00">G</div>
                <div class="key black" data-note="G#" data-freq="415.30">G#</div>
                <div class="key" data-note="A" data-freq="440.00">A</div>
                <div class="key black" data-note="A#" data-freq="466.16">A#</div>
                <div class="key" data-note="B" data-freq="493.88">B</div>
            </div>
            
            <div class="btn-grid">
                <button class="btn" onclick="startVocoder()">
                    <i class="fas fa-microphone"></i> Start
                </button>
                <button class="btn success" onclick="addVocoderTrack()">
                    <i class="fas fa-plus"></i> Add Track
                </button>
            </div>
        </div>

        <!-- Spectrum Analyzer Window -->
        <div class="window" id="analyzerWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-chart-line"></i> Spectrum Analyzer
                </div>
                <button class="close-btn" onclick="closeTool('analyzer')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <canvas class="spectrum-canvas" id="analyzerCanvas" width="350" height="200"></canvas>
            
            <div class="section-header">
                <i class="fas fa-cog"></i> Analyzer Settings
            </div>
            
            <div class="slider-group">
                <span class="slider-label">FFT Size</span>
                <select id="analyzerFFT" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="256">256</option>
                    <option value="512">512</option>
                    <option value="1024" selected>1024</option>
                    <option value="2048">2048</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Smoothing</span>
                <input type="range" class="slider" id="analyzerSmoothing" min="0" max="0.9" step="0.1" value="0.8">
                <span class="slider-value" id="analyzerSmoothingVal">0.8</span>
            </div>
            
            <div class="btn-grid">
                <button class="btn" onclick="freezeSpectrum()">
                    <i class="fas fa-pause"></i> Freeze
                </button>
                <button class="btn premium" onclick="exportSpectrum()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>

        <!-- Chromatic Tuner Window -->
        <div class="window" id="tunerWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-guitar"></i> Chromatic Tuner
                </div>
                <button class="close-btn" onclick="closeTool('tuner')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="tuner-display">
                <div class="tuner-note" id="tunerNote">--</div>
                <div class="tuner-cents" id="tunerCents">Play a note to tune</div>
                <div class="tuner-meter">
                    <div class="tuner-pointer" id="tunerPointer"></div>
                </div>
            </div>
            
            <div class="section-header">
                <i class="fas fa-cog"></i> Tuner Settings
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Reference</span>
                <input type="range" class="slider" id="tunerReference" min="415" max="465" value="440">
                <span class="slider-value" id="tunerReferenceVal">440Hz</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Temperament</span>
                <select id="tunerTemperament" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="equal">Equal Temperament</option>
                    <option value="just">Just Intonation</option>
                    <option value="pythagorean">Pythagorean</option>
                </select>
            </div>
            
            <div class="btn-grid">
                <button class="btn premium" id="tunerBtn" onclick="toggleTuner()">
                    <i class="fas fa-play"></i> Start Tuner
                </button>
                <button class="btn" onclick="calibrateTuner()">
                    <i class="fas fa-crosshairs"></i> Calibrate
                </button>
            </div>
        </div>

        <!-- Advanced Metronome Window -->
        <div class="window" id="metronomeWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-clock"></i> Advanced Metronome
                </div>
                <button class="close-btn" onclick="closeTool('metronome')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-tachometer-alt"></i> Tempo Control
            </div>
            
            <div class="slider-group">
                <span class="slider-label">BPM</span>
                <input type="range" class="slider" id="metronomeSlider" min="40" max="200" value="120">
                <span class="slider-value" id="metronomeBPM">120</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Time Sig</span>
                <select id="metronomeTimeSignature" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="2/4">2/4</option>
                    <option value="6/8">6/8</option>
                    <option value="7/8">7/8</option>
                    <option value="5/4">5/4</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Volume</span>
                <input type="range" class="slider" id="metronomeVolume" min="0" max="100" value="70">
                <span class="slider-value" id="metronomeVol">70%</span>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Sound</span>
                <select id="metronomeSound" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="click">Digital Click</option>
                    <option value="beep">Electronic Beep</option>
                    <option value="wood">Wood Block</option>
                    <option value="cowbell">Cowbell</option>
                </select>
            </div>
            
            <div class="btn-grid">
                <button class="btn premium" id="metronomeBtn" onclick="toggleMetronome()">
                    <i class="fas fa-play"></i> Start
                </button>
                <button class="btn" onclick="tapTempo()">
                    <i class="fas fa-hand-pointer"></i> Tap Tempo
                </button>
            </div>
        </div>

        <!-- Audio Import Window -->
        <div class="window" id="importWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-upload"></i> Import Audio
                </div>
                <button class="close-btn" onclick="closeTool('import')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Import Audio Files</h3>
                <p>Supports WAV, MP3, FLAC, AAC, OGG</p>
                <p>Drag & drop or tap to select files</p>
            </div>
            <input type="file" id="fileInput" accept="audio/*" multiple style="display: none;">
            
            <div class="section-header">
                <i class="fas fa-cloud"></i> Sample Library
            </div>
            
            <div class="tool-grid">
                <div class="tool-card" onclick="loadSamplePack('drums')">
                    <i class="fas fa-drum"></i>
                    <h3>Drum Samples</h3>
                    <p>Professional drum library</p>
                </div>
                <div class="tool-card" onclick="loadSamplePack('loops')">
                    <i class="fas fa-redo"></i>
                    <h3>Music Loops</h3>
                    <p>High-quality music loops</p>
                </div>
                <div class="tool-card" onclick="loadSamplePack('fx')">
                    <i class="fas fa-magic"></i>
                    <h3>Sound Effects</h3>
                    <p>Creative sound effects</p>
                </div>
                <div class="tool-card" onclick="openCloudLibrary()">
                    <i class="fas fa-cloud"></i>
                    <h3>Cloud Library</h3>
                    <p>Access online samples</p>
                </div>
            </div>
            
            <div class="btn-grid">
                <button class="btn" onclick="createNewTrack()">
                    <i class="fas fa-plus"></i> New Track
                </button>
                <button class="btn success" onclick="loadProject()">
                    <i class="fas fa-folder-open"></i> Load Project
                </button>
            </div>
        </div>

        <!-- Professional Export Window -->
        <div class="window" id="exportWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-download"></i> Export & Share
                </div>
                <button class="close-btn" onclick="closeTool('export')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-file-audio"></i> Audio Export
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Format</span>
                <select id="exportFormat" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="wav">WAV (Uncompressed)</option>
                    <option value="mp3">MP3 (Compressed)</option>
                    <option value="flac">FLAC (Lossless)</option>
                    <option value="aac">AAC (High Quality)</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Quality</span>
                <select id="exportQuality" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="44100">44.1 kHz (CD Quality)</option>
                    <option value="48000">48 kHz (Professional)</option>
                    <option value="96000">96 kHz (High Resolution)</option>
                    <option value="192000">192 kHz (Ultra High)</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Bit Depth</span>
                <select id="exportBitDepth" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="16">16-bit</option>
                    <option value="24">24-bit</option>
                    <option value="32">32-bit Float</option>
                </select>
            </div>
            
            <div class="btn-grid">
                <button class="btn premium" onclick="exportMix()">
                    <i class="fas fa-download"></i> Export Mix
                </button>
                <button class="btn" onclick="exportStems()">
                    <i class="fas fa-layer-group"></i> Export Stems
                </button>
                <button class="btn" onclick="exportMIDI()">
                    <i class="fas fa-music"></i> Export MIDI
                </button>
                <button class="btn" onclick="exportVideo()">
                    <i class="fas fa-video"></i> Export Video
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-share"></i> Share & Collaborate
            </div>
            
            <div class="btn-grid">
                <button class="btn success" onclick="shareToCloud()">
                    <i class="fas fa-cloud-upload-alt"></i> Share to Cloud
                </button>
                <button class="btn" onclick="collaborateProject()">
                    <i class="fas fa-users"></i> Collaborate
                </button>
                <button class="btn premium" onclick="saveProject()">
                    <i class="fas fa-save"></i> Save Project
                </button>
                <button class="btn" onclick="loadProject()">
                    <i class="fas fa-folder-open"></i> Load Project
                </button>
            </div>
        </div>

        <!-- Settings Window -->
        <div class="window" id="settingsWindow">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-cog"></i> Settings
                </div>
                <button class="close-btn" onclick="closeWindow('settings')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="section-header">
                <i class="fas fa-volume-up"></i> Audio Settings
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Buffer Size</span>
                <select id="bufferSize" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="128">128 samples (Low Latency)</option>
                    <option value="256" selected>256 samples (Balanced)</option>
                    <option value="512">512 samples (Stable)</option>
                    <option value="1024">1024 samples (High Stability)</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Sample Rate</span>
                <select id="sampleRate" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="44100" selected>44.1 kHz</option>
                    <option value="48000">48 kHz</option>
                    <option value="96000">96 kHz</option>
                </select>
            </div>
            
            <div class="section-header">
                <i class="fas fa-mobile-alt"></i> Interface Settings
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Theme</span>
                <select id="themeSelect" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white;">
                    <option value="dark" selected>Dark Theme</option>
                    <option value="light">Light Theme</option>
                    <option value="neon">Neon Theme</option>
                    <option value="minimal">Minimal Theme</option>
                </select>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Haptic Feedback</span>
                <label style="flex: 1; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="hapticFeedback" checked style="width: 20px; height: 20px;">
                    <span>Enable vibration feedback</span>
                </label>
            </div>
            
            <div class="slider-group">
                <span class="slider-label">Auto-save</span>
                <label style="flex: 1; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="autoSave" checked style="width: 20px; height: 20px;">
                    <span>Save project automatically</span>
                </label>
            </div>
            
            <div class="section-header">
                <i class="fas fa-shield-alt"></i> Performance
            </div>
            
            <div class="slider-group">
                <span class="slider-label">CPU Usage</span>
                <div style="flex: 1; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Current: <span id="cpuUsage">12%</span></span>
                        <span style="color: #2ed573;">Normal</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <div id="cpuBar" style="width: 12%; height: 100%; background: linear-gradient(90deg, #2ed573, #ffa502); border-radius: 4px; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
            
            <div class="btn-grid">
                <button class="btn" onclick="resetSettings()">
                    <i class="fas fa-undo"></i> Reset All
                </button>
                <button class="btn success" onclick="applySettings()">
                    <i class="fas fa-check"></i> Apply
                </button>
            </div>
        </div>
    </div>

    <!-- Transport Controls -->
    <div class="transport-bar">
        <button class="transport-btn" id="stopBtn" onclick="stopPlayback()">
            <i class="fas fa-stop"></i>
        </button>
        <button class="transport-btn" id="playBtn" onclick="togglePlayback()">
            <i class="fas fa-play"></i>
        </button>
        <button class="transport-btn record" id="recordBtn" onclick="toggleRecord()">
            <i class="fas fa-circle"></i>
        </button>
        <div class="time-display" id="timeDisplay">00:00</div>
        <button class="transport-btn" id="loopBtn" onclick="toggleLoop()">
            <i class="fas fa-redo"></i>
        </button>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="quickRecord()">
        <i class="fas fa-microphone"></i>
    </button>

    <script>
        // Audio Context and Global Variables
        let audioContext;
        let masterGain;
        let analyser;
        let dataArray;
        let isPlaying = false;
        let isRecording = false;
        let currentTime = 0;
        let bpm = 120;
        let tracks = [];
        let activeWindow = 'tracks';
        let synthOscillators = {};
        let bassOscillators = {};
        let vocoderOscillators = {};
        let drumSounds = {};
        let effects = {};
        let sequencerPattern = [];
        let sequencerStep = 0;
        let sequencerInterval;
        let tunerAnalyser;
        let tunerActive = false;
        let metronomeActive = false;
        let metronomeInterval;
        let sampleBuffers = {};
        let recordingStream;
        let mediaRecorder;
        let recordedChunks = [];
        let masteringEnabled = false;
        let vocoderActive = false;
        let tapTempoTimes = [];
        let spectrumFrozen = false;
        let projectData = {
            name: 'Untitled Project',
            tracks: [],
            bpm: 120,
            timeSignature: '4/4',
            effects: {},
            settings: {}
        };

        // Initialize Audio System
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                analyser = audioContext.createAnalyser();
                
                masterGain.connect(analyser);
                analyser.connect(audioContext.destination);
                
                analyser.fftSize = 1024;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // Initialize all audio components
                initDrumSounds();
                initEffects();
                initSampleBuffers();
                
                // Start visual updates
                updateVisuals();
                updateCPUUsage();
                
                updateStatus('Pro Audio System Initialized');
                
            } catch (error) {
                console.error('Audio initialization failed:', error);
                updateStatus('Audio initialization failed - using fallback mode');
            }
        }

        // Initialize Professional Drum Sounds
        function initDrumSounds() {
            drumSounds = {
                kick: () => createAdvancedDrumSound('kick'),
                snare: () => createAdvancedDrumSound('snare'),
                hihat: () => createAdvancedDrumSound('hihat'),
                crash: () => createAdvancedDrumSound('crash'),
                openhat: () => createAdvancedDrumSound('openhat'),
                clap: () => createAdvancedDrumSound('clap'),
                perc1: () => createAdvancedDrumSound('perc1'),
                perc2: () => createAdvancedDrumSound('perc2')
            };
        }

        // Create Advanced Drum Sounds with Real-time Synthesis
        function createAdvancedDrumSound(type) {
            if (!audioContext) return;
            
            const now = audioContext.currentTime;
            let oscillator, noise, filter, envelope, distortion;
            
            switch(type) {
                case 'kick':
                    oscillator = audioContext.createOscillator();
                    envelope = audioContext.createGain();
                    filter = audioContext.createBiquadFilter();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(60, now);
                    oscillator.frequency.exponentialRampToValueAtTime(0.01, now + 0.5);
                    
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(100, now);
                    filter.Q.setValueAtTime(1, now);
                    
                    envelope.gain.setValueAtTime(0.8, now);
                    envelope.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    
                    oscillator.connect(filter);
                    filter.connect(envelope);
                    envelope.connect(masterGain);
                    
                    oscillator.start(now);
                    oscillator.stop(now + 0.5);
                    break;
                    
                case 'snare':
                    // Create noise for snare
                    const bufferSize = audioContext.sampleRate * 0.2;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const output = buffer.getChannelData(0);
                    
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                    
                    noise = audioContext.createBufferSource();
                    noise.buffer = buffer;
                    
                    filter = audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.setValueAtTime(1000, now);
                    
                    envelope = audioContext.createGain();
                    envelope.gain.setValueAtTime(0.5, now);
                    envelope.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    
                    // Add tone component
                    oscillator = audioContext.createOscillator();
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(200, now);
                    
                    const toneEnv = audioContext.createGain();
                    toneEnv.gain.setValueAtTime(0.3, now);
                    toneEnv.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    
                    noise.connect(filter);
                    filter.connect(envelope);
                    oscillator.connect(toneEnv);
                    
                    const merger = audioContext.createChannelMerger(2);
                    envelope.connect(merger, 0, 0);
                    toneEnv.connect(merger, 0, 1);
                    merger.connect(masterGain);
                    
                    noise.start(now);
                    oscillator.start(now);
                    noise.stop(now + 0.2);
                    oscillator.stop(now + 0.1);
                    break;
                    
                case 'hihat':
                    const hihatBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
                    const hihatOutput = hihatBuffer.getChannelData(0);
                    
                    for (let i = 0; i < hihatOutput.length; i++) {
                        hihatOutput[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / hihatOutput.length, 2);
                    }
                    
                    noise = audioContext.createBufferSource();
                    noise.buffer = hihatBuffer;
                    
                    filter = audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.setValueAtTime(8000, now);
                    filter.Q.setValueAtTime(1, now);
                    
                    envelope = audioContext.createGain();
                    envelope.gain.setValueAtTime(0.3, now);
                    envelope.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    
                    noise.connect(filter);
                    filter.connect(envelope);
                    envelope.connect(masterGain);
                    
                    noise.start(now);
                    noise.stop(now + 0.1);
                    break;
                    
                case 'crash':
                    const crashBuffer = audioContext.createBuffer(2, audioContext.sampleRate * 2, audioContext.sampleRate);
                    
                    for (let channel = 0; channel < 2; channel++) {
                        const channelData = crashBuffer.getChannelData(channel);
                        for (let i = 0; i < channelData.length; i++) {
                            channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / channelData.length, 0.5);
                        }
                    }
                    
                    noise = audioContext.createBufferSource();
                    noise.buffer = crashBuffer;
                    
                    filter = audioContext.createBiquadFilter();
                    filter.type = 'bandpass';
                    filter.frequency.setValueAtTime(5000, now);
                    filter.Q.setValueAtTime(0.5, now);
                    
                    envelope = audioContext.createGain();
                    envelope.gain.setValueAtTime(0.4, now);
                    envelope.gain.exponentialRampToValueAtTime(0.01, now + 2);
                    
                    noise.connect(filter);
                    filter.connect(envelope);
                    envelope.connect(masterGain);
                    
                    noise.start(now);
                    noise.stop(now + 2);
                    break;
                    
                default:
                    // Generic percussion sound
                    oscillator = audioContext.createOscillator();
                    envelope = audioContext.createGain();
                    
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(800 + Math.random() * 400, now);
                    
                    envelope.gain.setValueAtTime(0.3, now);
                    envelope.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    
                    oscillator.connect(envelope);
                    envelope.connect(masterGain);
                    
                    oscillator.start(now);
                    oscillator.stop(now + 0.15);
            }
        }

        // Initialize Advanced Effects
        function initEffects() {
            effects = {
                chorus: { 
                    active: false, 
                    rate: 2, 
                    depth: 50,
                    node: null,
                    lfo: null,
                    delay: null
                },
                flanger: { 
                    active: false, 
                    rate: 0.5, 
                    feedback: 70,
                    node: null,
                    lfo: null,
                    delay: null
                },
                delay: { 
                    active: false, 
                    time: 250, 
                    feedback: 30,
                    node: null,
                    feedbackNode: null
                },
                reverb: { 
                    active: false, 
                    room: 50, 
                    decay: 2,
                    node: null,
                    convolver: null
                },
                distortion: { 
                    active: false, 
                    drive: 25, 
                    tone: 50,
                    node: null,
                    filter: null
                },
                bitcrusher: { 
                    active: false, 
                    bits: 8, 
                    rate: 22050,
                    node: null
                }
            };
            
            // Create effect nodes
            createEffectNodes();
        }

        // Create Web Audio Effect Nodes
        function createEffectNodes() {
            if (!audioContext) return;
            
            // Chorus
            effects.chorus.delay = audioContext.createDelay(0.02);
            effects.chorus.lfo = audioContext.createOscillator();
            effects.chorus.lfoGain = audioContext.createGain();
            effects.chorus.wetGain = audioContext.createGain();
            effects.chorus.dryGain = audioContext.createGain();
            
            effects.chorus.lfo.type = 'sine';
            effects.chorus.lfo.frequency.setValueAtTime(effects.chorus.rate, audioContext.currentTime);
            effects.chorus.lfoGain.gain.setValueAtTime(0.005, audioContext.currentTime);
            
            effects.chorus.lfo.connect(effects.chorus.lfoGain);
            effects.chorus.lfoGain.connect(effects.chorus.delay.delayTime);
            effects.chorus.lfo.start();
            
            // Delay
            effects.delay.node = audioContext.createDelay(1.0);
            effects.delay.feedbackNode = audioContext.createGain();
            effects.delay.wetGain = audioContext.createGain();
            effects.delay.dryGain = audioContext.createGain();
            
            effects.delay.node.delayTime.setValueAtTime(effects.delay.time / 1000, audioContext.currentTime);
            effects.delay.feedbackNode.gain.setValueAtTime(effects.delay.feedback / 100, audioContext.currentTime);
            
            effects.delay.node.connect(effects.delay.feedbackNode);
            effects.delay.feedbackNode.connect(effects.delay.node);
            
            // Reverb (using convolution)
            effects.reverb.convolver = audioContext.createConvolver();
            createReverbImpulse();
            
            // Distortion
            effects.distortion.node = audioContext.createWaveShaper();
            effects.distortion.filter = audioContext.createBiquadFilter();
            createDistortionCurve();
            
            // Bitcrusher (using ScriptProcessor for older browsers, AudioWorklet for newer)
            try {
                effects.bitcrusher.node = audioContext.createScriptProcessor(4096, 1, 1);
                effects.bitcrusher.node.onaudioprocess = processBitcrusher;
            } catch (e) {
                console.warn('Bitcrusher not available');
            }
        }

        // Create Reverb Impulse Response
        function createReverbImpulse() {
            const length = audioContext.sampleRate * effects.reverb.decay;
            const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    const decay = Math.pow(1 - i / length, 2);
                    channelData[i] = (Math.random() * 2 - 1) * decay;
                }
            }
            
            effects.reverb.convolver.buffer = impulse;
        }

        // Create Distortion Curve
        function createDistortionCurve() {
            const samples = 44100;
            const curve = new Float32Array(samples);
            const deg = Math.PI / 180;
            const drive = effects.distortion.drive;
            
            for (let i = 0; i < samples; i++) {
                const x = (i * 2) / samples - 1;
                curve[i] = ((3 + drive) * x * 20 * deg) / (Math.PI + drive * Math.abs(x));
            }
            
            effects.distortion.node.curve = curve;
            effects.distortion.node.oversample = '4x';
        }

        // Bitcrusher Audio Processing
        function processBitcrusher(event) {
            const input = event.inputBuffer.getChannelData(0);
            const output = event.outputBuffer.getChannelData(0);
            const bits = effects.bitcrusher.bits;
            const normfreq = effects.bitcrusher.rate / audioContext.sampleRate;
            const step = Math.pow(1/2, bits);
            
            let phaser = 0;
            let last = 0;
            
            for (let i = 0; i < input.length; i++) {
                phaser += normfreq;
                if (phaser >= 1.0) {
                    phaser -= 1.0;
                    last = step * Math.floor(input[i] / step + 0.5);
                }
                output[i] = last;
            }
        }

        // Initialize Sample Buffers
        function initSampleBuffers() {
            sampleBuffers = {
                loaded: {},
                loading: new Set()
            };
        }

        // Advanced Synthesizer Functions
        function playSynthNote(frequency) {
            if (!audioContext) return;
            
            const noteId = frequency.toString();
            if (synthOscillators[noteId]) return; // Prevent duplicate notes
            
            // Get synth parameters
            const wave1 = document.getElementById('synthWave1').value;
            const wave2 = document.getElementById('synthWave2').value;
            const mix = document.getElementById('synthMix').value / 100;
            const detune = document.getElementById('synthDetune').value;
            const cutoff = document.getElementById('synthCutoff').value;
            const resonance = document.getElementById('synthResonance').value;
            const attack = parseFloat(document.getElementById('synthAttack').value);
            const decay = parseFloat(document.getElementById('synthDecay').value);
            const sustain = parseFloat(document.getElementById('synthSustain').value);
            const release = parseFloat(document.getElementById('synthRelease').value);
            
            // Create oscillators
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const filter = audioContext.createBiquadFilter();
            const envelope = audioContext.createGain();
            const gain1 = audioContext.createGain();
            const gain2 = audioContext.createGain();
            
            // Configure oscillators
            osc1.type = wave1;
            osc1.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            osc2.type = wave2;
            osc2.frequency.setValueAtTime(frequency, audioContext.currentTime);
            osc2.detune.setValueAtTime(detune, audioContext.currentTime);
            
            // Configure filter
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(cutoff, audioContext.currentTime);
            filter.Q.setValueAtTime(resonance, audioContext.currentTime);
            
            // Configure gains
            gain1.gain.setValueAtTime(1 - mix, audioContext.currentTime);
            gain2.gain.setValueAtTime(mix, audioContext.currentTime);
            
            // Connect nodes
            osc1.connect(gain1);
            osc2.connect(gain2);
            gain1.connect(filter);
            gain2.connect(filter);
            filter.connect(envelope);
            envelope.connect(masterGain);
            
            // ADSR Envelope
            const now = audioContext.currentTime;
            envelope.gain.setValueAtTime(0, now);
            envelope.gain.linearRampToValueAtTime(0.3, now + attack);
            envelope.gain.linearRampToValueAtTime(0.3 * sustain, now + attack + decay);
            
            // Start oscillators
            osc1.start(now);
            osc2.start(now);
            
            // Store for note off
            synthOscillators[noteId] = {
                oscillators: [osc1, osc2],
                envelope: envelope,
                release: release,
                startTime: now
            };
        }

        function stopSynthNote(frequency) {
            const noteId = frequency.toString();
            if (!synthOscillators[noteId]) return;
            
            const { oscillators, envelope, release } = synthOscillators[noteId];
            const now = audioContext.currentTime;
            
            // Release envelope
            envelope.gain.cancelScheduledValues(now);
            envelope.gain.setValueAtTime(envelope.gain.value, now);
            envelope.gain.linearRampToValueAtTime(0, now + release);
            
            // Stop oscillators
            oscillators.forEach(osc => {
                osc.stop(now + release);
            });
            
            // Clean up
            setTimeout(() => {
                delete synthOscillators[noteId];
            }, (release * 1000) + 100);
        }

        // Bass Synthesizer Functions
        function playBassNote(frequency) {
            if (!audioContext) return;
            
            const noteId = 'bass_' + frequency.toString();
            if (bassOscillators[noteId]) return;
            
            const wave = document.getElementById('bassWave').value;
            const subOsc = document.getElementById('bassSubOsc').value / 100;
            const distortion = document.getElementById('bassDistortion').value / 100;
            const cutoff = document.getElementById('bassCutoff').value;
            const resonance = document.getElementById('bassResonance').value;
            
            // Main oscillator
            const mainOsc = audioContext.createOscillator();
            mainOsc.type = wave;
            mainOsc.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            // Sub oscillator (one octave down)
            const subOscillator = audioContext.createOscillator();
            subOscillator.type = 'sine';
            subOscillator.frequency.setValueAtTime(frequency / 2, audioContext.currentTime);
            
            // Gains
            const mainGain = audioContext.createGain();
            const subGain = audioContext.createGain();
            const envelope = audioContext.createGain();
            
            mainGain.gain.setValueAtTime(0.7, audioContext.currentTime);
            subGain.gain.setValueAtTime(subOsc, audioContext.currentTime);
            
            // Filter
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(cutoff, audioContext.currentTime);
            filter.Q.setValueAtTime(resonance, audioContext.currentTime);
            
            // Distortion
            let distortionNode = null;
            if (distortion > 0) {
                distortionNode = audioContext.createWaveShaper();
                const curve = new Float32Array(44100);
                for (let i = 0; i < 44100; i++) {
                    const x = (i * 2) / 44100 - 1;
                    curve[i] = Math.sign(x) * (1 - Math.exp(-Math.abs(x) * distortion * 10));
                }
                distortionNode.curve = curve;
            }
            
            // Connect nodes
            mainOsc.connect(mainGain);
            subOscillator.connect(subGain);
            
            const merger = audioContext.createChannelMerger(2);
            mainGain.connect(merger, 0, 0);
            subGain.connect(merger, 0, 1);
            
            if (distortionNode) {
                merger.connect(distortionNode);
                distortionNode.connect(filter);
            } else {
                merger.connect(filter);
            }
            
            filter.connect(envelope);
            envelope.connect(masterGain);
            
            // Envelope
            const now = audioContext.currentTime;
            envelope.gain.setValueAtTime(0, now);
            envelope.gain.linearRampToValueAtTime(0.4, now + 0.05);
            envelope.gain.linearRampToValueAtTime(0.3, now + 0.1);
            
            // Start
            mainOsc.start(now);
            subOscillator.start(now);
            
            bassOscillators[noteId] = {
                oscillators: [mainOsc, subOscillator],
                envelope: envelope
            };
        }

        function stopBassNote(frequency) {
            const noteId = 'bass_' + frequency.toString();
            if (!bassOscillators[noteId]) return;
            
            const { oscillators, envelope } = bassOscillators[noteId];
            const now = audioContext.currentTime;
            
            envelope.gain.cancelScheduledValues(now);
            envelope.gain.setValueAtTime(envelope.gain.value, now);
            envelope.gain.linearRampToValueAtTime(0, now + 0.3);
            
            oscillators.forEach(osc => {
                osc.stop(now + 0.3);
            });
            
            setTimeout(() => {
                delete bassOscillators[noteId];
            }, 400);
        }

        // Drum Machine Functions
        function playDrum(drumType) {
            if (drumSounds[drumType]) {
                drumSounds[drumType]();
                
                // Visual feedback
                const pad = document.querySelector(`[data-drum="${drumType}"]`);
                if (pad) {
                    pad.classList.add('playing');
                    setTimeout(() => {
                        pad.classList.remove('playing');
                    }, 150);
                }
                
                vibrate(30);
            }
        }

        function initDrumSequencer() {
            const sequencer = document.getElementById('drumSequencer');
            if (!sequencer) return;
            
            sequencer.innerHTML = '';
            
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.textContent = i + 1;
                step.onclick = () => toggleStep(i);
                sequencer.appendChild(step);
            }
            
            // Initialize pattern
            if (sequencerPattern.length === 0) {
                sequencerPattern = new Array(16).fill(false);
            }
            
            updateSequencerDisplay();
        }

        function toggleStep(stepIndex) {
            sequencerPattern[stepIndex] = !sequencerPattern[stepIndex];
            updateSequencerDisplay();
            vibrate(20);
        }

        function updateSequencerDisplay() {
            const steps = document.querySelectorAll('#drumSequencer .step');
            steps.forEach((step, index) => {
                step.classList.toggle('active', sequencerPattern[index]);
            });
        }

        function toggleDrumPattern() {
            const playBtn = document.getElementById('drumPlayBtn');
            
            if (sequencerInterval) {
                clearInterval(sequencerInterval);
                sequencerInterval = null;
                playBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                document.querySelectorAll('#drumSequencer .step').forEach(step => step.classList.remove('playing'));
            } else {
                const stepTime = (60 / bpm / 4) * 1000; // 16th notes
                sequencerStep = 0;
                
                sequencerInterval = setInterval(() => {
                    // Remove previous playing indicator
                    document.querySelectorAll('#drumSequencer .step').forEach(step => step.classList.remove('playing'));
                    
                    // Add current step indicator
                    const steps = document.querySelectorAll('#drumSequencer .step');
                    if (steps[sequencerStep]) {
                        steps[sequencerStep].classList.add('playing');
                    }
                    
                    // Play drum if step is active
                    if (sequencerPattern[sequencerStep]) {
                        playDrum('kick'); // Could be made more sophisticated with different drums per step
                    }
                    
                    sequencerStep = (sequencerStep + 1) % 16;
                }, stepTime);
                
                playBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            }
        }

        function clearDrumPattern() {
            sequencerPattern.fill(false);
            updateSequencerDisplay();
            vibrate(50);
        }

        // Sampler Functions
        function playSample() {
            // Implementation for sample playback
            updateStatus('Sample playback feature');
            vibrate(50);
        }

        function loadSampleFile(file) {
            if (!audioContext) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                audioContext.decodeAudioData(e.target.result)
                    .then(buffer => {
                        sampleBuffers.loaded[file.name] = buffer;
                        updateStatus(`Sample loaded: ${file.name}`);
                    })
                    .catch(error => {
                        updateStatus(`Error loading sample: ${file.name}`);
                    });
            };
            reader.readAsArrayBuffer(file);
        }

        // Vocoder Functions
        function startVocoder() {
            if (!vocoderActive) {
                vocoderActive = true;
                updateStatus('Vocoder started - speak into microphone');
                initVocoderMicrophone();
            } else {
                vocoderActive = false;
                updateStatus('Vocoder stopped');
                stopVocoderMicrophone();
            }
            vibrate(50);
        }

        async function initVocoderMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                
                // Vocoder processing would go here
                // This is a simplified implementation
                
                updateStatus('Vocoder microphone active');
            } catch (error) {
                updateStatus('Microphone access denied');
                vocoderActive = false;
            }
        }

        function stopVocoderMicrophone() {
            // Stop vocoder processing
            updateStatus('Vocoder microphone stopped');
        }

        // Track Management
        function addSynthTrack() {
            const track = {
                id: Date.now(),
                name: `Synth ${tracks.length + 1}`,
                type: 'synth',
                volume: 80,
                pan: 0,
                muted: false,
                solo: false,
                effects: [],
                automation: []
            };
            
            tracks.push(track);
            projectData.tracks = tracks;
            renderTracks();
            updateStatus(`Added ${track.name}`);
            vibrate(50);
        }

        function addDrumTrack() {
            const track = {
                id: Date.now(),
                name: `Drums ${tracks.length + 1}`,
                type: 'drums',
                volume: 80,
                pan: 0,
                muted: false,
                solo: false,
                pattern: [...sequencerPattern],
                automation: []
            };
            
            tracks.push(track);
            projectData.tracks = tracks;
            renderTracks();
            updateStatus(`Added ${track.name}`);
            vibrate(50);
        }

        function addBassTrack() {
            const track = {
                id: Date.now(),
                name: `Bass ${tracks.length + 1}`,
                type: 'bass',
                volume: 80,
                pan: 0,
                muted: false,
                solo: false,
                effects: [],
                automation: []
            };
            
            tracks.push(track);
            projectData.tracks = tracks;
            renderTracks();
            updateStatus(`Added ${track.name}`);
            vibrate(50);
        }

        function addSamplerTrack() {
            const track = {
                id: Date.now(),
                name: `Sampler ${tracks.length + 1}`,
                type: 'sampler',
                volume: 80,
                pan: 0,
                muted: false,
                solo: false,
                sample: null,
                automation: []
            };
            
            tracks.push(track);
            projectData.tracks = tracks;
            renderTracks();
            updateStatus(`Added ${track.name}`);
            vibrate(50);
        }

        function addVocoderTrack() {
            const track = {
                id: Date.now(),
                name: `Vocoder ${tracks.length + 1}`,
                type: 'vocoder',
                volume: 80,
                pan: 0,
                muted: false,
                solo: false,
                effects: [],
                automation: []
            };
            
            tracks.push(track);
            projectData.tracks = tracks;
            renderTracks();
            updateStatus(`Added ${track.name}`);
            vibrate(50);
        }

        function deleteTrack(trackId) {
            tracks = tracks.filter(track => track.id !== trackId);
            projectData.tracks = tracks;
            renderTracks();
            updateStatus('Track deleted');
            vibrate(75);
        }

        function toggleTrackMute(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (track) {
                track.muted = !track.muted;
                renderTracks();
                vibrate(30);
            }
        }

        function toggleTrackSolo(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (track) {
                track.solo = !track.solo;
                renderTracks();
                vibrate(30);
            }
        }

        function updateTrackVolume(trackId, volume) {
            const track = tracks.find(t => t.id === trackId);
            if (track) {
                track.volume = volume;
                vibrate(20);
            }
        }

        function updateTrackPan(trackId, pan) {
            const track = tracks.find(t => t.id === trackId);
            if (track) {
                track.pan = pan;
                vibrate(20);
            }
        }

        function renderTracks() {
            const trackList = document.getElementById('trackList');
            if (!trackList) return;
            
            trackList.innerHTML = '';
            
            if (tracks.length === 0) {
                trackList.innerHTML = `
                    <div style="text-align: center; padding: 50px; opacity: 0.6;">
                        <i class="fas fa-music" style="font-size: 3rem; margin-bottom: 20px; color: #00f5ff;"></i>
                        <h3>No tracks yet</h3>
                        <p>Use the studio tools to create your first track</p>
                    </div>
                `;
                return;
            }
            
            tracks.forEach(track => {
                const trackElement = document.createElement('div');
                trackElement.className = 'track';
                trackElement.innerHTML = `
                    <div class="track-header">
                        <div class="track-info">
                            <div class="track-icon" style="background: ${getTrackColor(track.type)};">
                                <i class="fas fa-${getTrackIcon(track.type)}"></i>
                            </div>
                            <div>
                                <div class="track-name">${track.name}</div>
                                <div class="track-type">${track.type.toUpperCase()}</div>
                            </div>
                        </div>
                        <div class="track-controls">
                            <button class="track-btn ${track.muted ? 'active' : ''}" onclick="toggleTrackMute(${track.id})">
                                <i class="fas fa-volume-mute"></i>
                            </button>
                            <button class="track-btn ${track.solo ? 'active' : ''}" onclick="toggleTrackSolo(${track.id})">
                                <i class="fas fa-headphones"></i>
                            </button>
                            <button class="track-btn record" onclick="toggleTrackRecord(${track.id})">
                                <i class="fas fa-circle"></i>
                            </button>
                            <button class="track-btn delete" onclick="deleteTrack(${track.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="waveform">
                        <canvas class="waveform-canvas" width="300" height="80"></canvas>
                        <div class="waveform-placeholder">Ready to record</div>
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <div class="automation-lane">
                        <div class="automation-point" style="left: 20%; top: 50%;"></div>
                        <div class="automation-point" style="left: 60%; top: 30%;"></div>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Volume</span>
                        <input type="range" class="slider" min="0" max="100" value="${track.volume}" 
                               onchange="updateTrackVolume(${track.id}, this.value)">
                        <span class="slider-value">${track.volume}%</span>
                    </div>
                    <div class="slider-group">
                        <span class="slider-label">Pan</span>
                        <input type="range" class="slider" min="-100" max="100" value="${track.pan}"
                               onchange="updateTrackPan(${track.id}, this.value)">
                        <span class="slider-value">${track.pan > 0 ? 'R' : track.pan < 0 ? 'L' : 'C'}${Math.abs(track.pan)}</span>
                    </div>
                `;
                trackList.appendChild(trackElement);
            });
        }

        function getTrackColor(type) {
            const colors = {
                synth: 'linear-gradient(45deg, #667eea, #764ba2)',
                drums: 'linear-gradient(45deg, #ff416c, #ff4b2b)',
                bass: 'linear-gradient(45deg, #2ed573, #1dd1a1)',
                sampler: 'linear-gradient(45deg, #ffa502, #ff6348)',
                vocoder: 'linear-gradient(45deg, #00f5ff, #ff00ff)',
                audio: 'linear-gradient(45deg, #a8edea, #fed6e3)'
            };
            return colors[type] || colors.audio;
        }

        function getTrackIcon(type) {
            const icons = {
                synth: 'piano',
                drums: 'drum',
                bass: 'guitar',
                sampler: 'compact-disc',
                vocoder: 'microphone-alt',
                audio: 'waveform-lines'
            };
            return icons[type] || icons.audio;
        }

        // Window Management
        function toggleWindow(windowName) {
            const windows = document.querySelectorAll('.window');
            const targetWindow = document.getElementById(windowName + 'Window');
            const button = document.getElementById(windowName + 'Btn');
            
            if (targetWindow && targetWindow.classList.contains('active')) {
                targetWindow.classList.remove('active');
                if (button) button.classList.remove('active');
                activeWindow = 'tracks';
                document.getElementById('tracksWindow').classList.add('active');
            } else if (targetWindow) {
                windows.forEach(w => w.classList.remove('active'));
                document.querySelectorAll('.header-btn').forEach(b => b.classList.remove('active'));
                
                targetWindow.classList.add('active');
                if (button) button.classList.add('active');
                activeWindow = windowName;
            }
        }

        function closeWindow(windowName) {
            const window = document.getElementById(windowName + 'Window');
            const button = document.getElementById(windowName + 'Btn');
            
            if (window) window.classList.remove('active');
            if (button) button.classList.remove('active');
            
            document.getElementById('tracksWindow').classList.add('active');
            activeWindow = 'tracks';
        }

        function closeAllWindows() {
            document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
            document.querySelectorAll('.header-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tracksWindow').classList.add('active');
            activeWindow = 'tracks';
        }

        function openTool(toolName) {
            closeAllWindows();
            const toolWindow = document.getElementById(toolName + 'Window');
            if (toolWindow) {
                toolWindow.classList.add('active');
                activeWindow = toolName;
                
                // Initialize tool-specific features
                if (toolName === 'drums') {
                    initDrumSequencer();
                } else if (toolName === 'analyzer') {
                    initSpectrumAnalyzer();
                }
            }
        }

        function closeTool(toolName) {
            const toolWindow = document.getElementById(toolName + 'Window');
            if (toolWindow) {
                toolWindow.classList.remove('active');
            }
            document.getElementById('tracksWindow').classList.add('active');
            activeWindow = 'tracks';
        }

        // Transport Controls
        async function togglePlayback() {
            if (!audioContext) {
                await initAudio();
            }
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playBtn.classList.add('active');
                startPlayback();
                updateStatus('Playing');
            } else {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                playBtn.classList.remove('active');
                pausePlayback();
                updateStatus('Paused');
            }
            
            vibrate(50);
        }

        function stopPlayback() {
            isPlaying = false;
            currentTime = 0;
            
            const playBtn = document.getElementById('playBtn');
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            playBtn.classList.remove('active');
            
            document.getElementById('stopBtn').classList.remove('active');
            updateTimeDisplay();
            updateStatus('Stopped');
            
            // Stop all playing notes
            Object.keys(synthOscillators).forEach(noteId => {
                const freq = parseFloat(noteId);
                stopSynthNote(freq);
            });
            
            Object.keys(bassOscillators).forEach(noteId => {
                const freq = parseFloat(noteId.replace('bass_', ''));
                stopBassNote(freq);
            });
            
            vibrate(30);
        }

        function startPlayback() {
            // Update progress bars and visual feedback
            updatePlaybackVisuals();
        }

        function pausePlayback() {
            // Pause without resetting time
        }

        function toggleRecord() {
            if (!audioContext) {
                initAudio();
            }
            
            isRecording = !isRecording;
            const recordBtn = document.getElementById('recordBtn');
            const indicator = document.getElementById('recordingIndicator');
            
            if (isRecording) {
                recordBtn.classList.add('active');
                indicator.classList.add('active');
                updateStatus('Recording...');
                startRecording();
            } else {
                recordBtn.classList.remove('active');
                indicator.classList.remove('active');
                updateStatus('Recording stopped');
                stopRecording();
            }
            
            vibrate(75);
        }

        async function startRecording() {
            try {
                recordingStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                mediaRecorder = new MediaRecorder(recordingStream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    processRecordedAudio(blob);
                };
                
                mediaRecorder.start();
                updateStatus('Recording audio...');
                
            } catch (error) {
                updateStatus('Recording failed - microphone access denied');
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('active');
                document.getElementById('recordingIndicator').classList.remove('active');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
        }

        function processRecordedAudio(blob) {
            // Convert blob to audio buffer and add to project
            const reader = new FileReader();
            reader.onload = function(e) {
                if (audioContext) {
                    audioContext.decodeAudioData(e.target.result)
                        .then(buffer => {
                            // Add recorded audio as new track
                            const track = {
                                id: Date.now(),
                                name: `Recording ${tracks.length + 1}`,
                                type: 'audio',
                                volume: 80,
                                pan: 0,
                                muted: false,
                                solo: false,
                                audioBuffer: buffer,
                                automation: []
                            };
                            
                            tracks.push(track);
                            projectData.tracks = tracks;
                            renderTracks();
                            updateStatus('Recording added to project');
                        })
                        .catch(error => {
                            updateStatus('Error processing recording');
                        });
                }
            };
            reader.readAsArrayBuffer(blob);
        }

        function toggleLoop() {
            const loopBtn = document.getElementById('loopBtn');
            loopBtn.classList.toggle('active');
            vibrate(30);
            
            if (loopBtn.classList.contains('active')) {
                updateStatus('Loop enabled');
            } else {
                updateStatus('Loop disabled');
            }
        }

        // Effects Functions
        function toggleEffect(effectName) {
            if (!effects[effectName]) return;
            
            effects[effectName].active = !effects[effectName].active;
            const toggle = document.getElementById(effectName + 'Toggle');
            const card = document.getElementById(effectName + 'Card');
            
            if (toggle) toggle.classList.toggle('active', effects[effectName].active);
            if (card) card.classList.toggle('active', effects[effectName].active);
            
            // Apply effect to audio chain
            applyEffect(effectName, effects[effectName].active);
            
            updateStatus(`${effectName} ${effects[effectName].active ? 'enabled' : 'disabled'}`);
            vibrate(30);
        }

        function applyEffect(effectName, enabled) {
            // This would connect/disconnect effect nodes in the audio graph
            // Implementation depends on the specific effect and audio routing
        }

        // Tuner Functions
        async function toggleTuner() {
            const btn = document.getElementById('tunerBtn');
            
            if (!tunerActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const source = audioContext.createMediaStreamSource(stream);
                    tunerAnalyser = audioContext.createAnalyser();
                    tunerAnalyser.fftSize = 2048;
                    
                    source.connect(tunerAnalyser);
                    
                    tunerActive = true;
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Tuner';
                    btn.classList.add('active');
                    
                    updateTuner();
                    updateStatus('Tuner active - play a note');
                    
                } catch (error) {
                    updateStatus('Microphone access denied');
                }
            } else {
                tunerActive = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Tuner';
                btn.classList.remove('active');
                document.getElementById('tunerNote').textContent = '--';
                document.getElementById('tunerCents').textContent = 'Tuner stopped';
                updateStatus('Tuner stopped');
            }
            
            vibrate(50);
        }

        function updateTuner() {
            if (!tunerActive || !tunerAnalyser) return;
            
            const bufferLength = tunerAnalyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            tunerAnalyser.getFloatTimeDomainData(buffer);
            
            const pitch = autoCorrelate(buffer, audioContext.sampleRate);
            
            if (pitch > 0) {
                const note = noteFromPitch(pitch);
                const cents = centsOffFromPitch(pitch, note);
                
                document.getElementById('tunerNote').textContent = noteNames[note % 12];
                document.getElementById('tunerCents').textContent = `${cents > 0 ? '+' : ''}${cents} cents`;
                
                // Update tuner meter
                const pointer = document.getElementById('tunerPointer');
                const position = 50 + (cents / 50) * 50; // Scale cents to percentage
                pointer.style.left = Math.max(0, Math.min(100, position)) + '%';
            }
            
            requestAnimationFrame(updateTuner);
        }

        // Note names for tuner display
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // Metronome Functions
        function toggleMetronome() {
            const btn = document.getElementById('metronomeBtn');
            
            if (!metronomeActive) {
                const bpmValue = parseInt(document.getElementById('metronomeSlider').value);
                const interval = (60 / bpmValue) * 1000;
                
                metronomeInterval = setInterval(() => {
                    playMetronomeClick();
                }, interval);
                
                metronomeActive = true;
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                btn.classList.add('active');
                updateStatus(`Metronome started at ${bpmValue} BPM`);
                
            } else {
                clearInterval(metronomeInterval);
                metronomeActive = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start';
                btn.classList.remove('active');
                updateStatus('Metronome stopped');
            }
            
            vibrate(50);
        }

        function playMetronomeClick() {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const volume = document.getElementById('metronomeVolume').value / 100;
            const sound = document.getElementById('metronomeSound').value;
            
            // Different sounds for metronome
            switch(sound) {
                case 'click':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    break;
                case 'beep':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    break;
                case 'wood':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    break;
                case 'cowbell':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                    break;
            }
            
            gainNode.gain.setValueAtTime(volume * 0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.connect(gainNode);
            gainNode.connect(masterGain);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
            
            vibrate(20);
        }

        function tapTempo() {
            const now = Date.now();
            tapTempoTimes.push(now);
            
            // Keep only last 4 taps
            if (tapTempoTimes.length > 4) {
                tapTempoTimes.shift();
            }
            
            if (tapTempoTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < tapTempoTimes.length; i++) {
                    intervals.push(tapTempoTimes[i] - tapTempoTimes[i-1]);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                const newBPM = Math.round(60000 / avgInterval);
                
                if (newBPM >= 40 && newBPM <= 200) {
                    document.getElementById('metronomeSlider').value = newBPM;
                    document.getElementById('metronomeBPM').textContent = newBPM;
                    bpm = newBPM;
                    updateStatus(`Tempo set to ${newBPM} BPM`);
                }
            }
            
            vibrate(30);
        }

        // Spectrum Analyzer Functions
        function initSpectrumAnalyzer() {
            const canvas = document.getElementById('analyzerCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            function drawSpectrum() {
                if (!analyser || !dataArray || spectrumFrozen) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                const width = canvas.width;
                const height = canvas.height;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(0, 0, width, height);
                
                const barWidth = width / dataArray.length;
                let x = 0;
                
                for (let i = 0; i < dataArray.length; i++) {
                    const barHeight = (dataArray[i] / 255) * height;
                    
                    const gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
                    gradient.addColorStop(0, '#00f5ff');
                    gradient.addColorStop(0.5, '#ff00ff');
                    gradient.addColorStop(1, '#ff416c');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, height - barHeight, barWidth, barHeight);
                    
                    x += barWidth;
                }
                
                requestAnimationFrame(drawSpectrum);
            }
            
            drawSpectrum();
        }

        function freezeSpectrum() {
            spectrumFrozen = !spectrumFrozen;
            const btn = document.querySelector('[onclick="freezeSpectrum()"]');
            if (btn) {
                btn.innerHTML = spectrumFrozen ? 
                    '<i class="fas fa-play"></i> Unfreeze' : 
                    '<i class="fas fa-pause"></i> Freeze';
            }
            updateStatus(spectrumFrozen ? 'Spectrum frozen' : 'Spectrum unfrozen');
            vibrate(30);
        }

        // Mastering Functions
        function toggleMastering() {
            masteringEnabled = !masteringEnabled;
            const btn = document.querySelector('[onclick="toggleMastering()"]');
            if (btn) {
                btn.innerHTML = masteringEnabled ? 
                    '<i class="fas fa-power-off"></i> Disable' : 
                    '<i class="fas fa-power-off"></i> Enable';
                btn.classList.toggle('active', masteringEnabled);
            }
            updateStatus(`Mastering suite ${masteringEnabled ? 'enabled' : 'disabled'}`);
            vibrate(50);
        }

        function analyzeLoudness() {
            updateStatus('Analyzing loudness... LUFS: -14.2, Peak: -1.2dB');
            vibrate(30);
        }

        // Export Functions
        
        // Export Functions
        async function exportMix() {
            updateStatus('Preparing professional export...');
            
            const format = document.getElementById('exportFormat').value;
            const quality = document.getElementById('exportQuality').value;
            const bitDepth = document.getElementById('exportBitDepth').value;
            
            // Create high-quality audio buffer
            const sampleRate = parseInt(quality);
            const duration = Math.max(10, currentTime || 30); // Default 30 seconds
            const channels = 2; // Stereo
            
            try {
                // Create offline audio context for rendering
                const offlineContext = new OfflineAudioContext(channels, sampleRate * duration, sampleRate);
                
                // Simulate mix rendering
                const buffer = offlineContext.createBuffer(channels, sampleRate * duration, sampleRate);
                
                // Generate demo audio content
                for (let channel = 0; channel < channels; channel++) {
                    const channelData = buffer.getChannelData(channel);
                    for (let i = 0; i < channelData.length; i++) {
                        // Create a simple mix with multiple frequencies
                        const time = i / sampleRate;
                        channelData[i] = 
                            Math.sin(2 * Math.PI * 440 * time) * 0.1 + // A4
                            Math.sin(2 * Math.PI * 220 * time) * 0.1 + // A3
                            Math.sin(2 * Math.PI * 880 * time) * 0.05;  // A5
                    }
                }
                
                // Convert to downloadable format
                const audioBlob = await bufferToWav(buffer, sampleRate, bitDepth);
                
                // Create download link
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mix_${Date.now()}.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateStatus(`Mix exported as ${format.toUpperCase()} (${quality}Hz/${bitDepth}-bit)`);
                vibrate(100);
                
            } catch (error) {
                updateStatus('Export failed - please try again');
                console.error('Export error:', error);
            }
        }

        async function exportStems() {
            updateStatus('Exporting individual stems...');
            
            // Export each track separately
            for (let i = 0; i < tracks.length; i++) {
                const track = tracks[i];
                
                // Create individual track export
                const buffer = audioContext.createBuffer(2, audioContext.sampleRate * 30, audioContext.sampleRate);
                
                // Generate track-specific content
                for (let channel = 0; channel < 2; channel++) {
                    const channelData = buffer.getChannelData(channel);
                    for (let j = 0; j < channelData.length; j++) {
                        const time = j / audioContext.sampleRate;
                        // Different frequency per track
                        const freq = 220 * Math.pow(2, i * 0.5);
                        channelData[j] = Math.sin(2 * Math.PI * freq * time) * 0.2;
                    }
                }
                
                const audioBlob = await bufferToWav(buffer, audioContext.sampleRate, 24);
                
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${track.name.replace(/\s+/g, '_')}_stem.wav`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            updateStatus(`${tracks.length} stems exported successfully`);
            vibrate(100);
        }

        function exportMIDI() {
            updateStatus('Exporting MIDI data...');
            
            // Create MIDI file content
            const midiData = createMIDIFile();
            const blob = new Blob([midiData], { type: 'audio/midi' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `project_${Date.now()}.mid`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('MIDI file exported');
            vibrate(50);
        }

        function exportVideo() {
            updateStatus('Video export feature coming soon!');
            vibrate(30);
        }

        // Audio Buffer to WAV conversion
        async function bufferToWav(buffer, sampleRate, bitDepth) {
            const length = buffer.length;
            const channels = buffer.numberOfChannels;
            const bytesPerSample = bitDepth / 8;
            const blockAlign = channels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = length * blockAlign;
            const bufferSize = 44 + dataSize;
            
            const arrayBuffer = new ArrayBuffer(bufferSize);
            const view = new DataView(arrayBuffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, bufferSize - 8, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(36, 'data');
            view.setUint32(40, dataSize, true);
            
            // Convert audio data
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < channels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    
                    if (bitDepth === 16) {
                        view.setInt16(offset, sample * 0x7FFF, true);
                        offset += 2;
                    } else if (bitDepth === 24) {
                        const intSample = Math.round(sample * 0x7FFFFF);
                        view.setUint8(offset, intSample & 0xFF);
                        view.setUint8(offset + 1, (intSample >> 8) & 0xFF);
                        view.setUint8(offset + 2, (intSample >> 16) & 0xFF);
                        offset += 3;
                    } else if (bitDepth === 32) {
                        view.setFloat32(offset, sample, true);
                        offset += 4;
                    }
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // Create MIDI file
        function createMIDIFile() {
            // Simplified MIDI file creation
            const header = new Uint8Array([
                0x4D, 0x54, 0x68, 0x64, // "MThd"
                0x00, 0x00, 0x00, 0x06, // Header length
                0x00, 0x00, // Format type 0
                0x00, 0x01, // Number of tracks
                0x00, 0x60  // Ticks per quarter note
            ]);
            
            const track = new Uint8Array([
                0x4D, 0x54, 0x72, 0x6B, // "MTrk"
                0x00, 0x00, 0x00, 0x0B, // Track length
                0x00, 0x90, 0x3C, 0x40, // Note on C4
                0x60, 0x80, 0x3C, 0x40, // Note off C4
                0x00, 0xFF, 0x2F, 0x00  // End of track
            ]);
            
            const midiFile = new Uint8Array(header.length + track.length);
            midiFile.set(header, 0);
            midiFile.set(track, header.length);
            
            return midiFile;
        }

        // Cloud and Collaboration Functions
        function shareToCloud() {
            updateStatus('Uploading to cloud... (Demo mode)');
            
            setTimeout(() => {
                const shareUrl = `https://mobiledaw.app/share/${Date.now()}`;
                updateStatus(`Project shared! URL: ${shareUrl}`);
                
                // Copy to clipboard if available
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareUrl);
                    updateStatus('Share URL copied to clipboard');
                }
            }, 2000);
            
            vibrate(50);
        }

        function collaborateProject() {
            updateStatus('Collaboration features coming soon!');
            vibrate(30);
        }

        // Project Management
        function saveProject() {
            const projectJson = JSON.stringify({
                ...projectData,
                timestamp: Date.now(),
                version: '1.0'
            });
            
            // Save to localStorage
            localStorage.setItem('mobiledaw_project', projectJson);
            
            // Also create downloadable file
            const blob = new Blob([projectJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectData.name.replace(/\s+/g, '_')}.mdaw`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('Project saved successfully');
            vibrate(50);
        }

        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.mdaw,.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const loadedProject = JSON.parse(e.target.result);
                        
                        // Validate project structure
                        if (loadedProject.name && loadedProject.tracks) {
                            projectData = loadedProject;
                            tracks = loadedProject.tracks || [];
                            bpm = loadedProject.bpm || 120;
                            
                            renderTracks();
                            updateStatus(`Loaded project: ${projectData.name}`);
                            vibrate(50);
                        } else {
                            updateStatus('Invalid project file');
                        }
                    } catch (error) {
                        updateStatus('Error loading project file');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Sample Library Functions
        function loadSamplePack(packType) {
            updateStatus(`Loading ${packType} sample pack...`);
            
            // Simulate loading samples
            setTimeout(() => {
                const sampleCount = Math.floor(Math.random() * 20) + 10;
                updateStatus(`Loaded ${sampleCount} ${packType} samples`);
                vibrate(30);
            }, 1500);
        }

        function openCloudLibrary() {
            updateStatus('Opening cloud sample library...');
            vibrate(30);
        }

        function createNewTrack() {
            addSynthTrack(); // Default to synth track
        }

        // Import Functions
        function setupFileImport() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileImport);
            }
            
            // Drag and drop support
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = 'rgba(0, 245, 255, 0.1)';
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = '';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = '';
                    
                    const files = Array.from(e.dataTransfer.files);
                    files.forEach(handleAudioFile);
                });
            }
        }

        function handleFileImport(event) {
            const files = Array.from(event.target.files);
            files.forEach(handleAudioFile);
        }

        function handleAudioFile(file) {
            if (!file.type.startsWith('audio/')) {
                updateStatus(`Unsupported file type: ${file.name}`);
                return;
            }
            
            updateStatus(`Importing ${file.name}...`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (audioContext) {
                    audioContext.decodeAudioData(e.target.result)
                        .then(buffer => {
                            // Create new audio track
                            const track = {
                                id: Date.now() + Math.random(),
                                name: file.name.replace(/\.[^/.]+$/, ""),
                                type: 'audio',
                                volume: 80,
                                pan: 0,
                                muted: false,
                                solo: false,
                                audioBuffer: buffer,
                                automation: []
                            };
                            
                            tracks.push(track);
                            projectData.tracks = tracks;
                            renderTracks();
                            updateStatus(`Imported: ${file.name}`);
                            vibrate(50);
                        })
                        .catch(error => {
                            updateStatus(`Error importing ${file.name}`);
                        });
                } else {
                    updateStatus('Audio system not initialized');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Settings Functions
        function applySettings() {
            const bufferSize = document.getElementById('bufferSize').value;
            const sampleRate = document.getElementById('sampleRate').value;
            const theme = document.getElementById('themeSelect').value;
            const haptic = document.getElementById('hapticFeedback').checked;
            const autoSave = document.getElementById('autoSave').checked;
            
            // Apply theme
            document.body.className = `theme-${theme}`;
            
            // Store settings
            const settings = {
                bufferSize: parseInt(bufferSize),
                sampleRate: parseInt(sampleRate),
                theme: theme,
                hapticFeedback: haptic,
                autoSave: autoSave
            };
            
            localStorage.setItem('mobiledaw_settings', JSON.stringify(settings));
            projectData.settings = settings;
            
            updateStatus('Settings applied successfully');
            vibrate(50);
        }

        function resetSettings() {
            // Reset to defaults
            document.getElementById('bufferSize').value = '256';
            document.getElementById('sampleRate').value = '44100';
            document.getElementById('themeSelect').value = 'dark';
            document.getElementById('hapticFeedback').checked = true;
            document.getElementById('autoSave').checked = true;
            
            applySettings();
            updateStatus('Settings reset to defaults');
            vibrate(75);
        }

        function loadSettings() {
            const saved = localStorage.getItem('mobiledaw_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    
                    if (document.getElementById('bufferSize')) {
                        document.getElementById('bufferSize').value = settings.bufferSize || 256;
                        document.getElementById('sampleRate').value = settings.sampleRate || 44100;
                        document.getElementById('themeSelect').value = settings.theme || 'dark';
                        document.getElementById('hapticFeedback').checked = settings.hapticFeedback !== false;
                        document.getElementById('autoSave').checked = settings.autoSave !== false;
                    }
                    
                    // Apply theme
                    document.body.className = `theme-${settings.theme || 'dark'}`;
                    
                } catch (error) {
                    console.warn('Error loading settings:', error);
                }
            }
        }

        // Utility Functions
        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = message;
                
                // Auto-clear status after 3 seconds
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = 'Ready';
                    }
                }, 3000);
            }
        }

        function vibrate(duration = 50) {
            if (navigator.vibrate && document.getElementById('hapticFeedback')?.checked !== false) {
                navigator.vibrate(duration);
            }
        }

        function updateTimeDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);
            const display = document.getElementById('timeDisplay');
            if (display) {
                display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updatePlaybackVisuals() {
            if (!isPlaying) return;
            
            currentTime += 0.1;
            updateTimeDisplay();
            
            // Update track progress bars
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const progress = (currentTime % 30) / 30 * 100; // 30 second loop
                bar.style.width = progress + '%';
            });
            
            setTimeout(updatePlaybackVisuals, 100);
        }

        function updateVisuals() {
            if (!analyser || !dataArray) {
                requestAnimationFrame(updateVisuals);
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            
            // Update level meters
            const avgLevel = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const levelBars = document.querySelectorAll('.level-bar');
            levelBars.forEach(bar => {
                bar.style.height = (avgLevel / 255 * 100) + '%';
            });
            
            requestAnimationFrame(updateVisuals);
        }

        function updateCPUUsage() {
            // Simulate CPU usage monitoring
            const usage = Math.random() * 30 + 10; // 10-40%
            const cpuElement = document.getElementById('cpuUsage');
            const cpuBar = document.getElementById('cpuBar');
            
            if (cpuElement) cpuElement.textContent = Math.round(usage) + '%';
            if (cpuBar) cpuBar.style.width = usage + '%';
            
            setTimeout(updateCPUUsage, 2000);
        }

        // Quick Record Function
        async function quickRecord() {
            if (!isRecording) {
                await toggleRecord();
                updateStatus('Quick recording started');
            } else {
                await toggleRecord();
                updateStatus('Quick recording stopped');
            }
        }

        // Pitch Detection Functions (for tuner)
        function autoCorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const rms = Math.sqrt(buffer.reduce((sum, val) => sum + val * val, 0) / SIZE);
            
            if (rms < 0.01) return -1; // Too quiet
            
            let r1 = 0, r2 = SIZE - 1;
            const threshold = 0.2;
            
            // Find the first point where amplitude crosses threshold
            for (let i = 0; i < SIZE / 2; i++) {
                if (Math.abs(buffer[i]) < threshold) {
                    r1 = i;
                    break;
                }
            }
            
            // Find the last point where amplitude crosses threshold
            for (let i = 1; i < SIZE / 2; i++) {
                if (Math.abs(buffer[SIZE - i]) < threshold) {
                    r2 = SIZE - i;
                    break;
                }
            }
            
            const trimmedBuffer = buffer.slice(r1, r2);
            const c = new Array(trimmedBuffer.length).fill(0);
            
            // Autocorrelation
            for (let i = 0; i < trimmedBuffer.length; i++) {
                for (let j = 0; j < trimmedBuffer.length - i; j++) {
                    c[i] += trimmedBuffer[j] * trimmedBuffer[j + i];
                }
            }
            
            let d = 0;
            while (c[d] > c[d + 1]) d++;
            
            let maxval = -1, maxpos = -1;
            for (let i = d; i < trimmedBuffer.length; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }
            
            let T0 = maxpos;
            
            // Parabolic interpolation
            const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
            const a = (x1 - 2 * x2 + x3) / 2;
            const b = (x3 - x1) / 2;
            
            if (a) T0 = T0 - b / (2 * a);
            
            return sampleRate / T0;
        }

        function noteFromPitch(frequency) {
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            return Math.round(noteNum) + 69;
        }

        function centsOffFromPitch(frequency, note) {
            return Math.floor(1200 * Math.log(frequency / frequencyFromNoteNumber(note)) / Math.log(2));
        }

        function frequencyFromNoteNumber(note) {
            return 440 * Math.pow(2, (note - 69) / 12);
        }

        // Slider Update Functions
        function updateSliderValue(sliderId, valueId, suffix = '') {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            
            if (slider && valueDisplay) {
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value + suffix;
                });
            }
        }

        // Initialize all slider updates
        function initSliderUpdates() {
            // Synth sliders
            updateSliderValue('synthMix', 'synthMixVal', '%');
            updateSliderValue('synthDetune', 'synthDetuneVal', ' cents');
            updateSliderValue('synthCutoff', 'synthCutoffVal', ' Hz');
            updateSliderValue('synthResonance', 'synthResonanceVal');
            updateSliderValue('synthAttack', 'synthAttackVal', 's');
            updateSliderValue('synthDecay', 'synthDecayVal', 's');
            updateSliderValue('synthSustain', 'synthSustainVal');
            updateSliderValue('synthRelease', 'synthReleaseVal', 's');
            
            // Bass sliders
            updateSliderValue('bassSubOsc', 'bassSubOscVal', '%');
            updateSliderValue('bassDistortion', 'bassDistortionVal', '%');
            updateSliderValue('bassCutoff', 'bassCutoffVal', ' Hz');
            updateSliderValue('bassResonance', 'bassResonanceVal');
            
            // Vocoder sliders
            updateSliderValue('vocoderCarrier', 'vocoderCarrierVal', ' Hz');
            updateSliderValue('vocoderModulator', 'vocoderModulatorVal', '%');
            updateSliderValue('vocoderBands', 'vocoderBandsVal');
            updateSliderValue('vocoderAttack', 'vocoderAttackVal', 'ms');
            updateSliderValue('vocoderRelease', 'vocoderReleaseVal', 'ms');
            
            // Analyzer sliders
            updateSliderValue('analyzerSmoothing', 'analyzerSmoothingVal');
            
            // Tuner sliders
            updateSliderValue('tunerReference', 'tunerReferenceVal', 'Hz');
            
            // Metronome sliders
            updateSliderValue('metronomeSlider', 'metronomeBPM');
            updateSliderValue('metronomeVolume', 'metronomeVol', '%');
        }

        // Keyboard Event Handlers
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Prevent default for our shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case ' ':
                            e.preventDefault();
                            togglePlayback();
                            break;
                        case 's':
                            e.preventDefault();
                            saveProject();
                            break;
                        case 'o':
                            e.preventDefault();
                            loadProject();
                            break;
                        case 'r':
                            e.preventDefault();
                            toggleRecord();
                            break;
                    }
                }
                
                // Piano keyboard mapping
                const keyMap = {
                    'a': 261.63, // C
                    'w': 277.18, // C#
                    's': 293.66, // D
                    'e': 311.13, // D#
                    'd': 329.63, // E
                    'f': 349.23, // F
                    't': 369.99, // F#
                    'g': 392.00, // G
                    'y': 415.30, // G#
                    'h': 440.00, // A
                    'u': 466.16, // A#
                    'j': 493.88  // B
                };
                
                if (keyMap[e.key.toLowerCase()] && activeWindow === 'synth') {
                    playSynthNote(keyMap[e.key.toLowerCase()]);
                }
            });
            
            document.addEventListener('keyup', function(e) {
                const keyMap = {
                    'a': 261.63, 'w': 277.18, 's': 293.66, 'e': 311.13,
                    'd': 329.63, 'f': 349.23, 't': 369.99, 'g': 392.00,
                    'y': 415.30, 'h': 440.00, 'u': 466.16, 'j': 493.88
                };
                
                if (keyMap[e.key.toLowerCase()] && activeWindow === 'synth') {
                    stopSynthNote(keyMap[e.key.toLowerCase()]);
                }
            });
        }

        // Initialize Application
        async function initApp() {
            updateStatus('Initializing Mobile DAW...');
            
            // Load settings first
            loadSettings();
            
            // Initialize audio system
            await initAudio();
            
            // Setup UI components
            initSliderUpdates();
            setupKeyboardShortcuts();
            setupFileImport();
            
            // Initialize default view
            renderTracks();
            
            // Load saved project if exists
            const savedProject = localStorage.getItem('mobiledaw_project');
            if (savedProject) {
                try {
                    projectData = JSON.parse(savedProject);
                    tracks = projectData.tracks || [];
                    bpm = projectData.bpm || 120;
                    renderTracks();
                    updateStatus(`Loaded: ${projectData.name}`);
                } catch (error) {
                    updateStatus('Ready to create music');
                }
            } else {
                updateStatus('Ready to create music');
            }
            
            // Auto-save setup
            if (document.getElementById('autoSave')?.checked !== false) {
                setInterval(() => {
                    if (tracks.length > 0) {
                        const projectJson = JSON.stringify({
                            ...projectData,
                            timestamp: Date.now()
                        });
                        localStorage.setItem('mobiledaw_autosave', projectJson);
                    }
                }, 30000); // Auto-save every 30 seconds
            }
            
            vibrate(100);
        }

        // Start the application when page loads
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Pause audio when page is hidden
                if (isPlaying) {
                    togglePlayback();
                }
            }
        });
        
        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                // Refresh canvas sizes and layouts
                if (activeWindow === 'analyzer') {
                    initSpectrumAnalyzer();
                }
            }, 100);
        });

        // Service Worker Registration (for PWA functionality)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>

