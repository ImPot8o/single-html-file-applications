
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Arena Pro - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white font-inter overflow-x-hidden">
    <!-- Mobile-First Layout -->
    <div class="flex flex-col h-screen max-w-full">
        <!-- Compact Header -->
        <header class="bg-black/20 backdrop-blur-xl border-b border-white/10 px-3 py-2 sticky top-0 z-40">
            <div class="flex items-center justify-between">
                <!-- Logo & Title -->
                <div class="flex items-center space-x-2">
                    <div class="text-xl">ü§ñ</div>
                    <div class="flex flex-col">
                        <h1 class="text-sm font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                            AI Arena Pro
                        </h1>
                        <div class="text-xs text-gray-400 hidden sm:block">Mobile Optimized</div>
                    </div>
                </div>

                <!-- Header Actions -->
                <div class="flex items-center space-x-1">
                    <button id="analyticsBtn" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors text-sm" title="Analytics">üìä</button>
                    <button id="setupBtn" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors text-sm" title="Settings">‚öôÔ∏è</button>
                    <button id="menuBtn" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors text-sm sm:hidden" title="Menu">‚ò∞</button>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="flex items-center justify-between mt-2 text-xs">
                <div id="statusDisplay" class="flex items-center space-x-2 text-gray-300">
                    <span id="statusText">Ready to chat</span>
                    <div id="thinkingDots" class="hidden flex space-x-1">
                        <div class="w-1 h-1 bg-cyan-400 rounded-full animate-bounce"></div>
                        <div class="w-1 h-1 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-1 h-1 bg-pink-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 text-xs">
                    <div class="flex items-center space-x-1">
                        <span>üí¨</span>
                        <span id="messageCounter">0</span>/<span id="maxDisplay">12</span>
                    </div>
                    <div id="battleScore" class="hidden flex items-center space-x-1">
                        <span>‚öîÔ∏è</span>
                        <span id="ai1Score" class="text-cyan-400">0</span>-<span id="ai2Score" class="text-purple-400">0</span>
                    </div>
                </div>
            </div>

            <!-- AI Models Display -->
            <div class="flex justify-center items-center space-x-2 mt-2">
                <div id="ai1ModelDisplay" class="flex items-center space-x-1 px-2 py-1 bg-cyan-500/20 rounded-full border border-cyan-400/30 text-xs">
                    <span>ü§ñ</span>
                    <span class="font-medium hidden sm:inline">Llama 3.1</span>
                    <div id="ai1Health" class="w-2 h-2 bg-green-400 rounded-full"></div>
                </div>
                <div class="text-yellow-400 font-bold text-xs">VS</div>
                <div id="ai2ModelDisplay" class="flex items-center space-x-1 px-2 py-1 bg-purple-500/20 rounded-full border border-purple-400/30 text-xs">
                    <span>üß†</span>
                    <span class="font-medium hidden sm:inline">Llama 3.1</span>
                    <div id="ai2Health" class="w-2 h-2 bg-green-400 rounded-full"></div>
                </div>
            </div>
        </header>

        <!-- Mobile Menu Overlay -->
        <div id="mobileMenu" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden sm:hidden">
            <div class="absolute right-0 top-0 h-full w-64 bg-slate-900/95 backdrop-blur-xl border-l border-white/10 p-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Menu</h3>
                    <button id="closeMobileMenu" class="text-2xl">√ó</button>
                </div>
                <div class="space-y-3">
                    <button id="mobileSetup" class="w-full p-3 bg-blue-500/20 rounded-lg text-left">‚öôÔ∏è Settings</button>
                    <button id="mobileAnalytics" class="w-full p-3 bg-purple-500/20 rounded-lg text-left">üìä Analytics</button>
                    <button id="mobileExport" class="w-full p-3 bg-green-500/20 rounded-lg text-left">üì§ Export</button>
                    <button id="mobileClear" class="w-full p-3 bg-red-500/20 rounded-lg text-left">üóëÔ∏è Clear</button>
                    <button id="mobileShare" class="w-full p-3 bg-yellow-500/20 rounded-lg text-left">üîó Share</button>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <main class="flex-1 overflow-hidden relative">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-5">
                <div class="absolute inset-0" style="background-image: radial-gradient(circle at 25% 25%, #06b6d4 0%, transparent 50%), radial-gradient(circle at 75% 75%, #8b5cf6 0%, transparent 50%);"></div>
            </div>
            
            <div id="chatContainer" class="h-full overflow-y-auto px-3 py-4 space-y-3 relative z-10">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="text-center py-8">
                    <div class="text-4xl mb-4 animate-bounce-slow">ü§ñüí¨üß†</div>
                    <h2 class="text-lg font-semibold mb-2 bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                        AI Chat Arena Pro
                    </h2>
                    <p class="text-sm text-gray-400 mb-6 px-4 leading-relaxed">
                        Watch AI models engage in fascinating conversations and debates
                    </p>
                    
                    <!-- Quick Start Cards -->
                    <div class="grid grid-cols-2 gap-2 max-w-sm mx-auto">
                        <button id="quickStart1" class="p-3 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-400/30 rounded-xl hover:from-cyan-500/30 hover:to-blue-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                            <div class="text-xl mb-1">üé≠</div>
                            <div class="text-xs font-medium">Debate</div>
                        </button>
                        
                        <button id="quickStart2" class="p-3 bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30 rounded-xl hover:from-purple-500/30 hover:to-pink-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                            <div class="text-xl mb-1">üß†</div>
                            <div class="text-xs font-medium">Philosophy</div>
                        </button>
                        
                        <button id="quickStart3" class="p-3 bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-400/30 rounded-xl hover:from-green-500/30 hover:to-emerald-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                            <div class="text-xl mb-1">üöÄ</div>
                            <div class="text-xs font-medium">Tech</div>
                        </button>
                        
                        <button id="quickStart4" class="p-3 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-400/30 rounded-xl hover:from-yellow-500/30 hover:to-orange-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                            <div class="text-xl mb-1">‚öîÔ∏è</div>
                            <div class="text-xs font-medium">Battle</div>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Controls -->
        <footer class="bg-black/20 backdrop-blur-xl border-t border-white/10 p-3 sticky bottom-0">
            <!-- Main Action Buttons -->
            <div class="flex gap-2 mb-3">
                <button id="beginChat" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 px-4 py-3 rounded-xl font-medium text-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95 shadow-lg">
                    <span class="flex items-center justify-center space-x-2">
                        <span>‚ñ∂Ô∏è</span>
                        <span>Start Chat</span>
                    </span>
                </button>
                
                <button id="stopChat" class="flex-1 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 px-4 py-3 rounded-xl font-medium text-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95 shadow-lg" disabled>
                    <span class="flex items-center justify-center space-x-2">
                        <span>‚èπÔ∏è</span>
                        <span>Stop</span>
                    </span>
                </button>
            </div>

            <!-- Secondary Actions (Desktop) -->
            <div class="hidden sm:flex gap-2 justify-center">
                <button id="exportBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs transition-all">üì§ Export</button>
                <button id="clearChat" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs transition-all">üóëÔ∏è Clear</button>
                <button id="shareBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs transition-all">üîó Share</button>
                <button id="randomizeBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs transition-all">üé≤ Random</button>
            </div>
        </footer>

        <!-- Setup Modal (Mobile Optimized) -->
        <div id="setupModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
            <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
                <div class="bg-slate-900/95 backdrop-blur-xl rounded-t-2xl sm:rounded-2xl w-full sm:max-w-2xl border-t sm:border border-white/20 max-h-[90vh] overflow-hidden">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-4 border-b border-white/20 sticky top-0 bg-slate-900/95 backdrop-blur-xl">
                        <div class="flex items-center space-x-2">
                            <div class="text-xl">‚öôÔ∏è</div>
                            <div>
                                <h2 class="text-lg font-semibold text-cyan-300">Settings</h2>
                                <p class="text-xs text-gray-400">Configure your AI experience</p>
                            </div>
                        </div>
                        <button id="closeModal" class="text-gray-400 hover:text-white text-2xl p-2 hover:bg-white/10 rounded-lg transition-colors">√ó</button>
                    </div>

                    <!-- Modal Content -->
                    <div class="p-4 overflow-y-auto" style="max-height: calc(90vh - 140px);">
                        <div class="space-y-6">
                            <!-- AI Models -->
                            <div class="space-y-4">
                                <h3 class="text-sm font-medium text-gray-200 flex items-center space-x-2">
                                    <span>ü§ñ</span>
                                    <span>AI Models</span>
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-cyan-300">AI 1 Model</label>
                                        <select id="ai1Model" class="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                                            <option value="@cf/meta/llama-3.1-8b-instruct">ü¶ô Llama 3.1 8B</option>
                                            <option value="@cf/meta/llama-3.1-70b-instruct">ü¶ô Llama 3.1 70B</option>
                                            <option value="@cf/microsoft/phi-2">üî¨ Phi-2</option>
                                            <option value="@cf/mistral/mistral-7b-instruct-v0.1">üå™Ô∏è Mistral 7B</option>
                                            <option value="@cf/qwen/qwen1.5-7b-chat-awq">üß† Qwen 1.5 7B</option>
                                            <option value="@cf/google/gemma-7b-it">üíé Gemma 7B</option>
                                            <option value="@cf/openchat/openchat-3.5-0106">üí¨ OpenChat 3.5</option>
                                            <option value="@cf/tinyllama/tinyllama-1.1b-chat-v1.0">üê£ TinyLlama 1.1B</option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-purple-300">AI 2 Model</label>
                                        <select id="ai2Model" class="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                                            <option value="@cf/meta/llama-3.1-8b-instruct">ü¶ô Llama 3.1 8B</option>
                                            <option value="@cf/meta/llama-3.1-70b-instruct">ü¶ô Llama 3.1 70B</option>
                                            <option value="@cf/microsoft/phi-2">üî¨ Phi-2</option>
                                            <option value="@cf/mistral/mistral-7b-instruct-v0.1">üå™Ô∏è Mistral 7B</option>
                                            <option value="@cf/qwen/qwen1.5-7b-chat-awq">üß† Qwen 1.5 7B</option>
                                            <option value="@cf/google/gemma-7b-it">üíé Gemma 7B</option>
                                            <option value="@cf/openchat/openchat-3.5-0106">üí¨ OpenChat 3.5</option>
                                            <option value="@cf/tinyllama/tinyllama-1.1b-chat-v1.0">üê£ TinyLlama 1.1B</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Personalities -->
                            <div class="space-y-4">
                                <h3 class="text-sm font-medium text-gray-200 flex items-center space-x-2">
                                    <span>üé≠</span>
                                    <span>AI Personalities</span>
                                </h3>
                                <div class="space-y-4">
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-cyan-300">AI 1 Personality</label>
                                        <textarea id="ai1Prompt" class="w-full h-20 px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-xs placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 resize-none" placeholder="Describe AI 1's personality...">You are an optimistic AI who always sees the bright side of things. You're enthusiastic, encouraging, and believe in the potential for positive change. Use markdown formatting and keep responses concise but insightful.</textarea>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-purple-300">AI 2 Personality</label>
                                        <textarea id="ai2Prompt" class="w-full h-20 px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-xs placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none" placeholder="Describe AI 2's personality...">You are a thoughtful skeptic who considers potential challenges and drawbacks. You're analytical, ask probing questions, and help others think critically. Use markdown formatting and keep responses concise but thorough.</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversation Starter -->
                            <div class="space-y-2">
                                <label class="text-xs font-medium text-yellow-300 flex items-center space-x-2">
                                    <span>üí≠</span>
                                    <span>Conversation Starter</span>
                                </label>
                                <input id="conversationStarter" type="text" class="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="What should they discuss?" value="What do you think about the future of artificial intelligence?">
                            </div>

                            <!-- Advanced Parameters -->
                            <div class="space-y-4">
                                <h3 class="text-sm font-medium text-gray-200 flex items-center space-x-2">
                                    <span>‚öôÔ∏è</span>
                                    <span>Advanced Parameters</span>
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-gray-200">AI 1 Temperature</label>
                                        <div class="flex items-center space-x-2">
                                            <input id="ai1Temperature" type="range" min="0.1" max="2.0" value="0.7" step="0.1" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                            <span id="ai1TempValue" class="text-xs text-gray-300 w-8 font-mono">0.7</span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-gray-200">AI 2 Temperature</label>
                                        <div class="flex items-center space-x-2">
                                            <input id="ai2Temperature" type="range" min="0.1" max="2.0" value="0.8" step="0.1" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                            <span id="ai2TempValue" class="text-xs text-gray-300 w-8 font-mono">0.8</span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-gray-200">AI 1 Max Tokens</label>
                                        <div class="flex items-center space-x-2">
                                            <input id="ai1MaxTokens" type="range" min="50" max="500" value="200" step="25" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                            <span id="ai1TokensValue" class="text-xs text-gray-300 w-8 font-mono">200</span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-gray-200">AI 2 Max Tokens</label>
                                        <div class="flex items-center space-x-2">
                                            <input id="ai2MaxTokens" type="range" min="50" max="500" value="200" step="25" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                            <span id="ai2TokensValue" class="text-xs text-gray-300 w-8 font-mono">200</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversation Settings -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-200">Max Messages</label>
                                    <div class="flex items-center space-x-2">
                                        <input id="maxMessages" type="range" min="5" max="50" value="12" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                        <span id="maxValue" class="text-xs text-gray-300 w-6 font-mono">12</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-200">Response Speed</label>
                                    <div class="flex items-center space-x-2">
                                        <input id="responseDelay" type="range" min="500" max="10000" value="2000" step="250" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                        <span id="delayValue" class="text-xs text-gray-300 w-6 font-mono">2s</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-200">Max Retries</label>
                                    <div class="flex items-center space-x-2">
                                        <input id="maxRetries" type="range" min="1" max="10" value="3" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                        <span id="retriesValue" class="text-xs text-gray-300 w-6 font-mono">3</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-200">Context Memory</label>
                                    <div class="flex items-center space-x-2">
                                        <input id="contextMemory" type="range" min="3" max="20" value="10" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                        <span id="contextValue" class="text-xs text-gray-300 w-6 font-mono">10</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Feature Toggles -->
                            <div class="space-y-3">
                                <h3 class="text-sm font-medium text-gray-200">Features</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/20">
                                        <div class="flex items-center space-x-2">
                                            <span>‚öîÔ∏è</span>
                                            <span class="text-sm">Battle Mode</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="battleMode" class="sr-only peer">
                                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-yellow-500 peer-checked:to-orange-500"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/20">
                                        <div class="flex items-center space-x-2">
                                            <span>üì§</span>
                                            <span class="text-sm">Auto Export</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="autoExport" class="sr-only peer">
                                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-green-500 peer-checked:to-emerald-500"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/20">
                                        <div class="flex items-center space-x-2">
                                            <span>üé®</span>
                                            <span class="text-sm">Rich Formatting</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="richFormatting" class="sr-only peer" checked>
                                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-blue-500 peer-checked:to-cyan-500"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/20">
                                        <div class="flex items-center space-x-2">
                                            <span>üîÑ</span>
                                            <span class="text-sm">Auto Retry</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="autoRetry" class="sr-only peer" checked>
                                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-500"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/20">
                                        <div class="flex items-center space-x-2">
                                            <span>üìä</span>
                                            <span class="text-sm">Live Analytics</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="liveAnalytics" class="sr-only peer" checked>
                                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-indigo-500 peer-checked:to-purple-500"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/20">
                                        <div class="flex items-center space-x-2">
                                            <span>üéµ</span>
                                            <span class="text-sm">Sound Effects</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="soundEffects" class="sr-only peer">
                                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-pink-500 peer-checked:to-rose-500"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- API Configuration -->
                            <div class="space-y-4">
                                <h3 class="text-sm font-medium text-gray-200 flex items-center space-x-2">
                                    <span>üîë</span>
                                    <span>API Configuration</span>
                                </h3>
                                <div class="space-y-3">
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-gray-200">Account ID</label>
                                        <input id="accountId" type="text" class="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Your Cloudflare Account ID" value="fce4a063063d8a931f3d09deaa67eb25">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-gray-200">API Key</label>
                                        <input id="apiKey" type="password" class="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Your Cloudflare API Key" value="oD3r69SMxj4_DVxS-q0pfA4fT_stTSkPwu6WM0Ce">
                                    </div>
                                    <div class="text-xs text-gray-400 bg-blue-500/10 border border-blue-400/30 rounded-lg p-3">
                                        <div class="flex items-start space-x-2">
                                            <span>‚ÑπÔ∏è</span>
                                            <div>
                                                <div class="font-medium text-blue-300 mb-1">API Configuration</div>
                                                <div>Get your credentials from the Cloudflare dashboard. Your data is stored locally and never shared.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="p-4 border-t border-white/20 flex justify-between sticky bottom-0 bg-slate-900/95 backdrop-blur-xl">
                        <button id="resetToDefaults" class="px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg font-medium transition-all duration-200 text-sm">üîÑ Reset</button>
                        <button id="saveSettings" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-lg font-medium transition-all duration-200 text-sm">‚úÖ Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Modal (Mobile Optimized) -->
        <div id="analyticsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
            <div class="flex items-end sm:items-center justify-center min-h-full p-0 sm:p-4">
                <div class="bg-slate-900/95 backdrop-blur-xl rounded-t-2xl sm:rounded-2xl w-full sm:max-w-4xl border-t sm:border border-white/20 max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b border-white/20">
                        <div class="flex items-center space-x-2">
                            <div class="text-xl">üìä</div>
                            <div>
                                <h2 class="text-lg font-semibold text-cyan-300">Analytics</h2>
                                <p class="text-xs text-gray-400">Performance insights</p>
                            </div>
                        </div>
                        <button id="closeAnalytics" class="text-gray-400 hover:text-white text-2xl p-2 hover:bg-white/10 rounded-lg transition-colors">√ó</button>
                    </div>
                    
                    <div class="p-4 overflow-y-auto" style="max-height: calc(90vh - 140px);">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-400/30 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xl font-bold text-cyan-300" id="totalConversations">0</div>
                                        <div class="text-xs text-gray-300">Conversations</div>
                                    </div>
                                    <div class="text-xl">üí¨</div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xl font-bold text-purple-300" id="totalMessages">0</div>
                                        <div class="text-xs text-gray-300">Messages</div>
                                    </div>
                                    <div class="text-xl">üìù</div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-400/30 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-xl font-bold text-yellow-300" id="avgResponseTime">0s</div>
                                        <div class="text-xs text-gray-300">Avg Response</div>
                                    </div>
                                    <div class="text-xl">‚ö°</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-white/5 rounded-xl p-4 border border-white/20">
                                <h3 class="text-sm font-medium mb-4 text-gray-200">Model Usage</h3>
                                <canvas id="modelUsageChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toastContainer" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-60 space-y-2 w-full max-w-sm px-4"></div>
    </div>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #06b6d4, #8b5cf6);
            border-radius: 2px;
        }

        /* Message Content Styling */
        .message-content {
            line-height: 1.5;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            font-weight: 600;
            margin: 0.5em 0 0.3em 0;
            color: #f1f5f9;
        }
        .message-content strong {
            font-weight: 600;
            color: #f8fafc;
        }
        .message-content code {
            background: rgba(0, 0, 0, 0.4);
            padding: 0.1em 0.4em;
            border-radius: 0.25em;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.85em;
            color: #fbbf24;
        }
        .message-content blockquote {
            border-left: 3px solid #6366f1;
            padding-left: 1em;
            margin: 0.5em 0;
            font-style: italic;
            color: #cbd5e1;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 0 0.25em 0.25em 0;
            padding: 0.5em 1em;
        }

        /* Toast Styling */
        .toast {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 0.875rem;
            animation: toast-slide-in 0.3s ease-out;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        @keyframes toast-slide-in {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Typing Animation */
        .typing-indicator {
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.2; transform: scale(0.8); }
        }

        /* Battle Winner Effect */
        .battle-winner {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            border-color: gold !important;
            position: relative;
        }

        .battle-winner::before {
            content: 'üëë';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 16px;
            animation: bounce 2s infinite;
        }

        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .message-content {
                font-size: 0.875rem;
            }
            
            /* Prevent zoom on input focus */
            input, textarea, select {
                font-size: 16px;
            }
            
            /* Better touch targets */
            button {
                min-height: 44px;
            }
        }

        /* Range Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(45deg, #06b6d4, #8b5cf6);
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-track {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            background: linear-gradient(45deg, #06b6d4, #8b5cf6);
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
    </style>

    <script>
        class AIChat {
            constructor() {
                alert("chances are you didn't set up the Ai so this won't work. Check the Ai config");
                this.accountId = '<cloudflare account id>';
                this.apiKey = '<cloudflare api key>';
                this.isRunning = false;
                this.messageCount = 0;
                this.retryCount = 0;
                this.ai1Score = 0;
                this.ai2Score = 0;
                this.conversation = [];
                this.maxRetries = 3;
                this.conversationHistory = [];
                this.startTime = null;
                this.analytics = {
                    totalConversations: 0,
                    totalMessages: 0,
                    modelUsage: {},
                    battleResults: { ai1: 0, ai2: 0, ties: 0 },
                    responseTimes: []
                };
                
                this.models = {
                    '@cf/meta/llama-3.1-8b-instruct': { name: 'Llama 3.1 8B', description: 'Fast and intelligent' },
                    '@cf/meta/llama-3.1-70b-instruct': { name: 'Llama 3.1 70B', description: 'Most powerful model' },
                    '@cf/microsoft/phi-2': { name: 'Phi-2', description: 'Creative and analytical' },
                    '@cf/mistral/mistral-7b-instruct-v0.1': { name: 'Mistral 7B', description: 'Well-balanced model' },
                    '@cf/qwen/qwen1.5-7b-chat-awq': { name: 'Qwen 1.5 7B', description: 'Advanced reasoning' },
                    '@cf/google/gemma-7b-it': { name: 'Gemma 7B', description: 'Google\'s efficient model' },
                    '@cf/openchat/openchat-3.5-0106': { name: 'OpenChat 3.5', description: 'Conversational expert' },
                    '@cf/tinyllama/tinyllama-1.1b-chat-v1.0': { name: 'TinyLlama 1.1B', description: 'Compact and fast' }
                };
                
                this.presets = {
                    debate: {
                        ai1: "You are an optimistic AI who always sees the bright side of things. You're enthusiastic, encouraging, and believe in the potential for positive change. You ask thoughtful questions and build on ideas constructively. Use markdown formatting like **bold**, *italic*, `code`, lists, and > quotes to make your responses engaging and well-structured. Keep responses concise but insightful.",
                        ai2: "You are a thoughtful skeptic who considers potential challenges and drawbacks. You're analytical, ask probing questions, and help others think critically. You're not negative, just realistic and thorough in your analysis. Use markdown formatting like **bold**, *italic*, `code`, lists, and > quotes to structure your responses clearly. Keep responses concise but thorough.",
                        starter: "What do you think about the future of artificial intelligence and its impact on society?"
                    },
                    philosophy: {
                        ai1: "You are a modern philosopher who believes in progress, technology, and human potential. You're curious about how new ideas can improve society and human experience. Use markdown formatting to structure your philosophical arguments with **key points**, *emphasis*, and > quotes from thinkers. Keep responses thoughtful and accessible.",
                        ai2: "You are inspired by ancient wisdom and traditional philosophy. You value time-tested principles and believe that many modern problems can be solved by returning to fundamental truths. Use markdown formatting with **bold concepts**, *italicized wisdom*, and > classical quotes. Keep responses grounded in timeless principles.",
                        starter: "What is the key to living a meaningful life in today's rapidly changing world?"
                    },
                    tech: {
                        ai1: "You are an AI enthusiast who is excited about technological advancement. You see AI as a tool for solving humanity's greatest challenges and improving quality of life. Use markdown with **bold tech terms**, `code examples`, and lists of benefits. Keep responses optimistic but realistic.",
                        ai2: "You are thoughtfully cautious about AI development. You appreciate the benefits but are concerned about potential risks, job displacement, and the need for careful regulation. Use markdown to structure your concerns with **key risks**, lists, and > important quotes. Keep responses balanced and constructive.",
                        starter: "How should we approach AI development to ensure it benefits everyone while minimizing risks?"
                    }
                };
                
                this.loadAnalytics();
                this.initializeElements();
                this.bindEvents();
                this.updateDisplays();
            }

            initializeElements() {
                // Get all DOM elements
                this.ai1PromptEl = document.getElementById('ai1Prompt');
                this.ai2PromptEl = document.getElementById('ai2Prompt');
                this.ai1ModelEl = document.getElementById('ai1Model');
                this.ai2ModelEl = document.getElementById('ai2Model');
                this.conversationStarterEl = document.getElementById('conversationStarter');
                this.beginBtn = document.getElementById('beginChat');
                this.stopBtn = document.getElementById('stopChat');
                this.clearBtn = document.getElementById('clearChat');
                this.setupBtn = document.getElementById('setupBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.randomizeBtn = document.getElementById('randomizeBtn');
                this.shareBtn = document.getElementById('shareBtn');
                this.maxMessagesEl = document.getElementById('maxMessages');
                this.responseDelayEl = document.getElementById('responseDelay');
                this.battleModeEl = document.getElementById('battleMode');
                this.autoExportEl = document.getElementById('autoExport');
                this.maxValueEl = document.getElementById('maxValue');
                this.delayValueEl = document.getElementById('delayValue');
                this.maxDisplayEl = document.getElementById('maxDisplay');
                this.messageCounterEl = document.getElementById('messageCounter');
                this.ai1ScoreEl = document.getElementById('ai1Score');
                this.ai2ScoreEl = document.getElementById('ai2Score');
                this.battleScoreEl = document.getElementById('battleScore');
                this.chatContainer = document.getElementById('chatContainer');
                this.statusTextEl = document.getElementById('statusText');
                this.thinkingDotsEl = document.getElementById('thinkingDots');
                this.ai1ModelDisplayEl = document.getElementById('ai1ModelDisplay');
                this.ai2ModelDisplayEl = document.getElementById('ai2ModelDisplay');
                this.ai1HealthEl = document.getElementById('ai1Health');
                this.ai2HealthEl = document.getElementById('ai2Health');
                this.setupModal = document.getElementById('setupModal');
                this.analyticsModal = document.getElementById('analyticsModal');
                this.closeModalBtn = document.getElementById('closeModal');
                this.closeAnalyticsBtn = document.getElementById('closeAnalytics');
                this.saveSettingsBtn = document.getElementById('saveSettings');
                this.analyticsBtn = document.getElementById('analyticsBtn');
                this.resetToDefaultsBtn = document.getElementById('resetToDefaults');
                this.toastContainer = document.getElementById('toastContainer');
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.mobileMenu = document.getElementById('mobileMenu');
                this.menuBtn = document.getElementById('menuBtn');
                this.closeMobileMenuBtn = document.getElementById('closeMobileMenu');
                
                // Advanced settings elements
                this.ai1TemperatureEl = document.getElementById('ai1Temperature');
                this.ai2TemperatureEl = document.getElementById('ai2Temperature');
                this.ai1MaxTokensEl = document.getElementById('ai1MaxTokens');
                this.ai2MaxTokensEl = document.getElementById('ai2MaxTokens');
                this.maxRetriesEl = document.getElementById('maxRetries');
                this.contextMemoryEl = document.getElementById('contextMemory');
                this.richFormattingEl = document.getElementById('richFormatting');
                this.autoRetryEl = document.getElementById('autoRetry');
                this.liveAnalyticsEl = document.getElementById('liveAnalytics');
                this.soundEffectsEl = document.getElementById('soundEffects');
                this.accountIdEl = document.getElementById('accountId');
                this.apiKeyEl = document.getElementById('apiKey');
                
                // Value display elements
                this.ai1TempValueEl = document.getElementById('ai1TempValue');
                this.ai2TempValueEl = document.getElementById('ai2TempValue');
                this.ai1TokensValueEl = document.getElementById('ai1TokensValue');
                this.ai2TokensValueEl = document.getElementById('ai2TokensValue');
                this.retriesValueEl = document.getElementById('retriesValue');
                this.contextValueEl = document.getElementById('contextValue');
            }

            bindEvents() {
                // Main controls
                this.beginBtn.addEventListener('click', () => this.startConversation());
                this.stopBtn.addEventListener('click', () => this.stopConversation());
                this.clearBtn.addEventListener('click', () => this.clearChat());
                this.setupBtn.addEventListener('click', () => this.openModal());
                this.exportBtn.addEventListener('click', () => this.exportConversation());
                this.randomizeBtn.addEventListener('click', () => this.randomizeSettings());
                this.shareBtn.addEventListener('click', () => this.shareConversation());
                
                // Modal controls
                this.closeModalBtn.addEventListener('click', () => this.closeModal());
                this.closeAnalyticsBtn.addEventListener('click', () => this.closeAnalyticsModal());
                this.saveSettingsBtn.addEventListener('click', () => this.closeModal());
                this.analyticsBtn.addEventListener('click', () => this.openAnalyticsModal());
                this.resetToDefaultsBtn.addEventListener('click', () => this.resetToDefaults());
                
                // Mobile menu
                this.menuBtn.addEventListener('click', () => this.openMobileMenu());
                this.closeMobileMenuBtn.addEventListener('click', () => this.closeMobileMenu());
                document.getElementById('mobileSetup').addEventListener('click', () => {
                    this.closeMobileMenu();
                    this.openModal();
                });
                document.getElementById('mobileAnalytics').addEventListener('click', () => {
                    this.closeMobileMenu();
                    this.openAnalyticsModal();
                });
                document.getElementById('mobileExport').addEventListener('click', () => {
                    this.closeMobileMenu();
                    this.exportConversation();
                });
                document.getElementById('mobileClear').addEventListener('click', () => {
                    this.closeMobileMenu();
                    this.clearChat();
                });
                document.getElementById('mobileShare').addEventListener('click', () => {
                    this.closeMobileMenu();
                    this.shareConversation();
                });
                
                // Settings updates
                this.maxMessagesEl.addEventListener('input', () => this.updateDisplays());
                this.responseDelayEl.addEventListener('input', () => this.updateDisplays());
                this.ai1ModelEl.addEventListener('change', () => this.updateDisplays());
                this.ai2ModelEl.addEventListener('change', () => this.updateDisplays());
                
                // Advanced settings updates
                this.ai1TemperatureEl.addEventListener('input', () => this.updateDisplays());
                this.ai2TemperatureEl.addEventListener('input', () => this.updateDisplays());
                this.ai1MaxTokensEl.addEventListener('input', () => this.updateDisplays());
                this.ai2MaxTokensEl.addEventListener('input', () => this.updateDisplays());
                this.maxRetriesEl.addEventListener('input', () => this.updateDisplays());
                this.contextMemoryEl.addEventListener('input', () => this.updateDisplays());
                
                // API settings updates
                this.accountIdEl.addEventListener('input', () => this.updateApiSettings());
                this.apiKeyEl.addEventListener('input', () => this.updateApiSettings());
                
                // Quick start buttons
                document.getElementById('quickStart1').addEventListener('click', () => this.loadPreset('debate'));
                document.getElementById('quickStart2').addEventListener('click', () => this.loadPreset('philosophy'));
                document.getElementById('quickStart3').addEventListener('click', () => this.loadPreset('tech'));
                document.getElementById('quickStart4').addEventListener('click', () => this.battleModeQuickStart());
                
                // Modal backdrop clicks
                this.setupModal.addEventListener('click', (e) => {
                    if (e.target === this.setupModal) this.closeModal();
                });
                this.analyticsModal.addEventListener('click', (e) => {
                    if (e.target === this.analyticsModal) this.closeAnalyticsModal();
                });
                this.mobileMenu.addEventListener('click', (e) => {
                    if (e.target === this.mobileMenu) this.closeMobileMenu();
                });
            }

            openMobileMenu() {
                this.mobileMenu.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeMobileMenu() {
                this.mobileMenu.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            updateDisplays() {
                // Basic settings
                this.maxValueEl.textContent = this.maxMessagesEl.value;
                this.maxDisplayEl.textContent = this.maxMessagesEl.value;
                this.delayValueEl.textContent = (this.responseDelayEl.value / 1000) + 's';
                
                // Advanced parameter displays
                if (this.ai1TempValueEl) this.ai1TempValueEl.textContent = this.ai1TemperatureEl.value;
                if (this.ai2TempValueEl) this.ai2TempValueEl.textContent = this.ai2TemperatureEl.value;
                if (this.ai1TokensValueEl) this.ai1TokensValueEl.textContent = this.ai1MaxTokensEl.value;
                if (this.ai2TokensValueEl) this.ai2TokensValueEl.textContent = this.ai2MaxTokensEl.value;
                if (this.retriesValueEl) this.retriesValueEl.textContent = this.maxRetriesEl.value;
                if (this.contextValueEl) this.contextValueEl.textContent = this.contextMemoryEl.value;
                
                // Model displays
                const ai1Model = this.models[this.ai1ModelEl.value];
                const ai2Model = this.models[this.ai2ModelEl.value];
                
                if (ai1Model) {
                    const ai1Display = this.ai1ModelDisplayEl.querySelector('span:nth-child(2)');
                    if (ai1Display) ai1Display.textContent = ai1Model.name.split(' ')[0] + ' ' + ai1Model.name.split(' ')[1];
                }
                
                if (ai2Model) {
                    const ai2Display = this.ai2ModelDisplayEl.querySelector('span:nth-child(2)');
                    if (ai2Display) ai2Display.textContent = ai2Model.name.split(' ')[0] + ' ' + ai2Model.name.split(' ')[1];
                }
            }

            updateApiSettings() {
                this.accountId = this.accountIdEl.value;
                this.apiKey = this.apiKeyEl.value;
            }

            loadPreset(presetName) {
                const preset = this.presets[presetName];
                if (preset) {
                    this.ai1PromptEl.value = preset.ai1;
                    this.ai2PromptEl.value = preset.ai2;
                    this.conversationStarterEl.value = preset.starter;
                    this.showToast(`‚úÖ Loaded ${presetName} preset`, 'success');
                }
            }

            battleModeQuickStart() {
                this.randomizeSettings();
                this.battleModeEl.checked = true;
                this.loadPreset('debate');
                this.conversationStarterEl.value = "Let's have an epic debate! Choose any topic you're passionate about and defend your position.";
                this.showToast('‚öîÔ∏è Battle mode activated!', 'info');
            }

            randomizeSettings() {
                const models = Object.keys(this.models);
                this.ai1ModelEl.value = models[Math.floor(Math.random() * models.length)];
                this.ai2ModelEl.value = models[Math.floor(Math.random() * models.length)];
                this.updateDisplays();
                this.showToast('üé≤ Settings randomized!', 'info');
            }

            resetToDefaults() {
                // Basic settings
                this.ai1ModelEl.value = '@cf/meta/llama-3.1-8b-instruct';
                this.ai2ModelEl.value = '@cf/meta/llama-3.1-8b-instruct';
                this.maxMessagesEl.value = '12';
                this.responseDelayEl.value = '2000';
                
                // Advanced parameters
                this.ai1TemperatureEl.value = '0.7';
                this.ai2TemperatureEl.value = '0.8';
                this.ai1MaxTokensEl.value = '200';
                this.ai2MaxTokensEl.value = '200';
                this.maxRetriesEl.value = '3';
                this.contextMemoryEl.value = '10';
                
                // Feature toggles
                this.battleModeEl.checked = false;
                this.autoExportEl.checked = false;
                this.richFormattingEl.checked = true;
                this.autoRetryEl.checked = true;
                this.liveAnalyticsEl.checked = true;
                this.soundEffectsEl.checked = false;
                
                // Load default preset
                this.loadPreset('debate');
                this.updateDisplays();
                this.showToast('üîÑ Reset to defaults', 'info');
            }

            openModal() {
                this.setupModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                this.setupModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                this.updateDisplays();
            }

            openAnalyticsModal() {
                this.analyticsModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                this.updateAnalyticsDisplay();
            }

            closeAnalyticsModal() {
                this.analyticsModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            updateStatus(status, showThinking = false) {
                this.statusTextEl.textContent = status;
                if (showThinking) {
                    this.thinkingDotsEl.classList.remove('hidden');
                } else {
                    this.thinkingDotsEl.classList.add('hidden');
                }
            }

            updateHealthIndicator(ai, status) {
                const healthEl = ai === 1 ? this.ai1HealthEl : this.ai2HealthEl;
                healthEl.className = `w-2 h-2 rounded-full`;
                if (status === 'good') healthEl.style.backgroundColor = '#10b981';
                else if (status === 'warning') healthEl.style.backgroundColor = '#f59e0b';
                else if (status === 'error') healthEl.style.backgroundColor = '#ef4444';
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                
                this.toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'toast-slide-out 0.3s ease-in forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            async callCloudflareAI(messages, systemPrompt, model, temperature = 0.7, maxTokens = 200, retryCount = 0) {
                const startTime = Date.now();
                
                try {
                    this.updateHealthIndicator(messages.length % 2 === 0 ? 1 : 2, 'warning');
                    
                    // Use current API settings
                    const accountId = this.accountIdEl ? this.accountIdEl.value : this.accountId;
                    const apiKey = this.apiKeyEl ? this.apiKeyEl.value : this.apiKey;
                    
                    const response = await fetch(`https://cloudflare-cors-anywhere.imnotfamous01.workers.dev/?https://api.cloudflare.com/client/v4/accounts/${accountId}/ai/run/${model}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: [
                                { role: 'system', content: systemPrompt },
                                ...messages.slice(-parseInt(this.contextMemoryEl ? this.contextMemoryEl.value : 10))
                            ],
                            max_tokens: parseInt(maxTokens),
                            temperature: parseFloat(temperature)
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (!data.result || !data.result.response) {
                        throw new Error('Invalid response format from API');
                    }

                    const responseTime = Date.now() - startTime;
                    this.analytics.responseTimes.push(responseTime);
                    this.updateHealthIndicator(messages.length % 2 === 0 ? 1 : 2, 'good');
                    
                    const modelName = this.models[model]?.name || model;
                    this.analytics.modelUsage[modelName] = (this.analytics.modelUsage[modelName] || 0) + 1;

                    return data.result.response.trim();
                } catch (error) {
                    this.updateHealthIndicator(messages.length % 2 === 0 ? 1 : 2, 'error');
                    
                    if (retryCount < this.maxRetries) {
                        this.retryCount++;
                        this.updateStatus(`Retrying... (${retryCount + 1}/${this.maxRetries})`, true);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return this.callCloudflareAI(messages, systemPrompt, model, temperature, maxTokens, retryCount + 1);
                    }
                    throw error;
                }
            }

            addMessageToChat(sender, message, isAI1 = true, isWinner = false) {
                // Hide welcome screen
                this.welcomeScreen.style.display = 'none';
                
                const messageEl = document.createElement('div');
                messageEl.className = `flex ${isAI1 ? 'justify-start' : 'justify-end'} mb-3 animate-slide-up`;
                
                let bubbleClass = isAI1 
                    ? 'bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border-cyan-400/30' 
                    : 'bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-purple-400/30';
                
                if (isWinner) {
                    bubbleClass += ' battle-winner';
                }
                
                const aiIcon = isAI1 ? 'ü§ñ' : 'üß†';
                const aiName = isAI1 ? 'AI 1' : 'AI 2';
                const modelName = isAI1 ? this.models[this.ai1ModelEl.value]?.name : this.models[this.ai2ModelEl.value]?.name;
                
                const renderedMessage = this.renderMarkdown(message);
                
                messageEl.innerHTML = `
                    <div class="max-w-xs sm:max-w-sm px-4 py-3 rounded-2xl border ${bubbleClass} backdrop-blur-sm relative">
                        <div class="flex items-center mb-2">
                            <span class="text-base mr-2">${aiIcon}</span>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold ${isAI1 ? 'text-cyan-300' : 'text-purple-300'}">${aiName}</span>
                                    ${isWinner ? '<span class="text-xs">üëë</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-400">${modelName?.split(' ')[0]} ${modelName?.split(' ')[1]}</div>
                            </div>
                        </div>
                        <div class="message-content text-white text-sm leading-relaxed">${renderedMessage}</div>
                        <div class="text-xs text-gray-400 mt-2 flex justify-between items-center">
                            <span>${this.getWordCount(message)} words</span>
                            <span>${this.getReadingTime(message)}</span>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(messageEl);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                
                this.messageCounterEl.textContent = this.messageCount;
                
                this.conversationHistory.push({
                    sender: aiName,
                    model: modelName,
                    message: message,
                    timestamp: new Date().toISOString(),
                    isWinner: isWinner,
                    wordCount: this.getWordCount(message)
                });
                
                this.analytics.totalMessages++;
            }

            renderMarkdown(text) {
                try {
                    if (typeof marked !== 'undefined') {
                        marked.setOptions({
                            breaks: true,
                            gfm: true
                        });
                        const html = marked.parse(text);
                        return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(html) : html;
                    }
                } catch (error) {
                    console.warn('Markdown rendering failed:', error);
                }
                
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
            }

            getWordCount(text) {
                return text.trim().split(/\s+/).filter(word => word.length > 0).length;
            }

            getReadingTime(text) {
                const wordsPerMinute = 200;
                const words = this.getWordCount(text);
                const minutes = Math.ceil(words / wordsPerMinute);
                return minutes === 1 ? '1min' : `${minutes}min`;
            }

            addTypingIndicator(isAI1 = true) {
                const typingEl = document.createElement('div');
                typingEl.id = 'typingIndicator';
                typingEl.className = `flex ${isAI1 ? 'justify-start' : 'justify-end'} mb-3`;
                
                const bubbleClass = isAI1 
                    ? 'bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border-cyan-400/20' 
                    : 'bg-gradient-to-r from-purple-500/10 to-pink-500/10 border-purple-400/20';
                
                const aiIcon = isAI1 ? 'ü§ñ' : 'üß†';
                
                typingEl.innerHTML = `
                    <div class="max-w-xs px-4 py-3 rounded-2xl border ${bubbleClass} backdrop-blur-sm">
                        <div class="flex items-center space-x-3">
                            <span class="text-base">${aiIcon}</span>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.chatContainer.appendChild(typingEl);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            removeTypingIndicator() {
                const typingEl = document.getElementById('typingIndicator');
                if (typingEl) {
                    typingEl.remove();
                }
            }

            evaluateBattleWinner(ai1Response, ai2Response) {
                let ai1Points = 0;
                let ai2Points = 0;
                
                // Length scoring
                const ai1Length = ai1Response.length;
                const ai2Length = ai2Response.length;
                const idealLength = 300;
                
                ai1Points += Math.max(0, 2 - Math.abs(ai1Length - idealLength) / 100);
                ai2Points += Math.max(0, 2 - Math.abs(ai2Length - idealLength) / 100);
                
                // Question scoring
                const ai1Questions = (ai1Response.match(/\?/g) || []).length;
                const ai2Questions = (ai2Response.match(/\?/g) || []).length;
                ai1Points += Math.min(ai1Questions, 2);
                ai2Points += Math.min(ai2Questions, 2);
                
                // Markdown formatting
                const ai1Markdown = (ai1Response.match(/\*\*|\*|`|>/g) || []).length;
                const ai2Markdown = (ai2Response.match(/\*\*|\*|`|>/g) || []).length;
                if (ai1Markdown > ai2Markdown) ai1Points += 1;
                else if (ai2Markdown > ai1Markdown) ai2Points += 1;
                
                // Vocabulary diversity
                const ai1Words = new Set(ai1Response.toLowerCase().split(/\W+/).filter(w => w.length > 3));
                const ai2Words = new Set(ai2Response.toLowerCase().split(/\W+/).filter(w => w.length > 3));
                if (ai1Words.size > ai2Words.size) ai1Points += 1;
                else if (ai2Words.size > ai1Words.size) ai2Points += 1;
                
                // Random factor
                if (Math.random() > 0.8) {
                    Math.random() > 0.5 ? ai1Points += 0.5 : ai2Points += 0.5;
                }
                
                return ai1Points > ai2Points ? 1 : (ai2Points > ai1Points ? 2 : 0);
            }

            updateBattleScore(winner) {
                if (winner === 1) {
                    this.ai1Score++;
                    this.analytics.battleResults.ai1++;
                } else if (winner === 2) {
                    this.ai2Score++;
                    this.analytics.battleResults.ai2++;
                } else {
                    this.analytics.battleResults.ties++;
                }
                
                this.ai1ScoreEl.textContent = this.ai1Score;
                this.ai2ScoreEl.textContent = this.ai2Score;
                this.battleScoreEl.classList.remove('hidden');
            }

            async startConversation() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.messageCount = 0;
                this.retryCount = 0;
                this.startTime = Date.now();
                this.ai1Conversation = [];
                this.ai2Conversation = [];
                this.conversationHistory = [];
                
                if (this.battleModeEl.checked) {
                    this.ai1Score = 0;
                    this.ai2Score = 0;
                    this.battleScoreEl.classList.remove('hidden');
                } else {
                    this.battleScoreEl.classList.add('hidden');
                }
                
                this.beginBtn.disabled = true;
                this.stopBtn.disabled = false;
                
                this.updateStatus('üöÄ Starting conversation...', false);

                const ai1Prompt = this.ai1PromptEl.value.trim();
                const ai2Prompt = this.ai2PromptEl.value.trim();
                const conversationStarter = this.conversationStarterEl.value.trim();
                const maxMessages = parseInt(this.maxMessagesEl.value);
                const responseDelay = parseInt(this.responseDelayEl.value);
                const battleMode = this.battleModeEl.checked;

                if (!ai1Prompt || !ai2Prompt) {
                    this.showToast('‚ùå Please set up both AI personalities first', 'error');
                    this.stopConversation();
                    return;
                }

                let currentAI = 1;
                let lastMessage = conversationStarter || "Hello! Let's have an interesting conversation.";
                
                this.addMessageToChat('Starter', lastMessage, true);
                
                this.ai1Conversation.push({ role: 'user', content: lastMessage });
                this.ai2Conversation.push({ role: 'user', content: lastMessage });
                this.messageCount = 1;

                try {
                    while (this.isRunning && this.messageCount < maxMessages) {
                        await new Promise(resolve => setTimeout(resolve, responseDelay));
                        
                        if (!this.isRunning) break;

                        const respondingAI = currentAI === 1 ? 2 : 1;
                        this.updateStatus(`ü§î AI ${respondingAI} thinking...`, true);
                        this.addTypingIndicator(respondingAI === 1);

                        let response;
                        let ai1Response = null;
                        let ai2Response = null;

                        if (battleMode && this.messageCount > 1) {
                            this.updateStatus('‚öîÔ∏è Battle mode: Both AIs responding...', true);
                            
                            try {
                                [ai1Response, ai2Response] = await Promise.all([
                                    this.callCloudflareAI(this.ai1Conversation, ai1Prompt, this.ai1ModelEl.value, 
                                        parseFloat(this.ai1TemperatureEl.value), parseInt(this.ai1MaxTokensEl.value)),
                                    this.callCloudflareAI(this.ai2Conversation, ai2Prompt, this.ai2ModelEl.value, 
                                        parseFloat(this.ai2TemperatureEl.value), parseInt(this.ai2MaxTokensEl.value))
                                ]);
                                
                                const winner = this.evaluateBattleWinner(ai1Response, ai2Response);
                                this.updateBattleScore(winner);
                                
                                this.removeTypingIndicator();
                                
                                if (winner === 1) {
                                    this.addMessageToChat('AI 1', ai1Response, true, true);
                                    response = ai1Response;
                                    currentAI = 1;
                                    this.ai1Conversation.push({ role: 'assistant', content: ai1Response });
                                    this.ai2Conversation.push({ role: 'user', content: ai1Response });
                                } else if (winner === 2) {
                                    this.addMessageToChat('AI 2', ai2Response, false, true);
                                    response = ai2Response;
                                    currentAI = 2;
                                    this.ai2Conversation.push({ role: 'assistant', content: ai2Response });
                                    this.ai1Conversation.push({ role: 'user', content: ai2Response });
                                } else {
                                    this.addMessageToChat('AI 1', ai1Response, true);
                                    this.addMessageToChat('AI 2', ai2Response, false);
                                    if (Math.random() > 0.5) {
                                        response = ai1Response;
                                        currentAI = 1;
                                        this.ai1Conversation.push({ role: 'assistant', content: ai1Response });
                                        this.ai2Conversation.push({ role: 'user', content: ai1Response });
                                    } else {
                                        response = ai2Response;
                                        currentAI = 2;
                                        this.ai2Conversation.push({ role: 'assistant', content: ai2Response });
                                        this.ai1Conversation.push({ role: 'user', content: ai2Response });
                                    }
                                }
                            } catch (error) {
                                if (currentAI === 1) {
                                    response = await this.callCloudflareAI(this.ai2Conversation, ai2Prompt, this.ai2ModelEl.value, 
                                        parseFloat(this.ai2TemperatureEl.value), parseInt(this.ai2MaxTokensEl.value));
                                    this.removeTypingIndicator();
                                    this.addMessageToChat('AI 2', response, false);
                                    currentAI = 2;
                                    this.ai2Conversation.push({ role: 'assistant', content: response });
                                    this.ai1Conversation.push({ role: 'user', content: response });
                                } else {
                                    response = await this.callCloudflareAI(this.ai1Conversation, ai1Prompt, this.ai1ModelEl.value, 
                                        parseFloat(this.ai1TemperatureEl.value), parseInt(this.ai1MaxTokensEl.value));
                                    this.removeTypingIndicator();
                                    this.addMessageToChat('AI 1', response, true);
                                    currentAI = 1;
                                    this.ai1Conversation.push({ role: 'assistant', content: response });
                                    this.ai2Conversation.push({ role: 'user', content: response });
                                }
                            }
                        } else {
                            if (currentAI === 1) {
                                response = await this.callCloudflareAI(this.ai2Conversation, ai2Prompt, this.ai2ModelEl.value, 
                                    parseFloat(this.ai2TemperatureEl.value), parseInt(this.ai2MaxTokensEl.value));
                                this.removeTypingIndicator();
                                this.addMessageToChat('AI 2', response, false);
                                currentAI = 2;
                                this.ai2Conversation.push({ role: 'assistant', content: response });
                                this.ai1Conversation.push({ role: 'user', content: response });
                            } else {
                                response = await this.callCloudflareAI(this.ai1Conversation, ai1Prompt, this.ai1ModelEl.value, 
                                    parseFloat(this.ai1TemperatureEl.value), parseInt(this.ai1MaxTokensEl.value));
                                this.removeTypingIndicator();
                                this.addMessageToChat('AI 1', response, true);
                                currentAI = 1;
                                this.ai1Conversation.push({ role: 'assistant', content: response });
                                this.ai2Conversation.push({ role: 'user', content: response });
                            }
                        }

                        this.messageCount++;
                        this.updateStatus(`üí¨ Message ${this.messageCount}/${maxMessages}`, false);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.removeTypingIndicator();
                    this.updateStatus('‚ùå Error occurred', false);
                    this.addMessageToChat('System', `‚ùå **Error**: ${error.message}`, true);
                    this.showToast('‚ùå Conversation failed', 'error');
                }

                if (this.messageCount >= maxMessages) {
                    let statusMsg = 'üéâ Conversation completed!';
                    if (battleMode) {
                        if (this.ai1Score > this.ai2Score) {
                            statusMsg += ' ü§ñ AI 1 Wins!';
                        } else if (this.ai2Score > this.ai1Score) {
                            statusMsg += ' üß† AI 2 Wins!';
                        } else {
                            statusMsg += ' ü§ù Tie!';
                        }
                    }
                    this.updateStatus(statusMsg, false);
                    this.showToast(statusMsg, 'success');
                }

                this.analytics.totalConversations++;
                this.saveAnalytics();

                if (this.autoExportEl.checked && this.conversationHistory.length > 0) {
                    setTimeout(() => this.exportConversation(), 1000);
                }

                this.stopConversation();
            }

            stopConversation() {
                this.isRunning = false;
                this.beginBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.removeTypingIndicator();
                
                if (this.messageCount === 0) {
                    this.updateStatus('Ready to chat', false);
                } else if (this.messageCount > 0) {
                    this.updateStatus(`‚úÖ Conversation ended (${this.messageCount} messages)`, false);
                }
                
                this.updateHealthIndicator(1, 'good');
                this.updateHealthIndicator(2, 'good');
            }

            clearChat() {
                this.chatContainer.innerHTML = `
                    <div id="welcomeScreen" class="text-center py-8">
                        <div class="text-4xl mb-4 animate-bounce-slow">ü§ñüí¨üß†</div>
                        <h2 class="text-lg font-semibold mb-2 bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                            AI Chat Arena Pro
                        </h2>
                        <p class="text-sm text-gray-400 mb-6 px-4 leading-relaxed">
                            Watch AI models engage in fascinating conversations and debates
                        </p>
                        
                        <div class="grid grid-cols-2 gap-2 max-w-sm mx-auto">
                            <button id="quickStart1" class="p-3 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-400/30 rounded-xl hover:from-cyan-500/30 hover:to-blue-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                                <div class="text-xl mb-1">üé≠</div>
                                <div class="text-xs font-medium">Debate</div>
                            </button>
                            
                            <button id="quickStart2" class="p-3 bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30 rounded-xl hover:from-purple-500/30 hover:to-pink-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                                <div class="text-xl mb-1">üß†</div>
                                <div class="text-xs font-medium">Philosophy</div>
                            </button>
                            
                            <button id="quickStart3" class="p-3 bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-400/30 rounded-xl hover:from-green-500/30 hover:to-emerald-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                                <div class="text-xl mb-1">üöÄ</div>
                                <div class="text-xs font-medium">Tech</div>
                            </button>
                            
                            <button id="quickStart4" class="p-3 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-400/30 rounded-xl hover:from-yellow-500/30 hover:to-orange-500/30 transition-all duration-300 transform hover:scale-105 active:scale-95">
                                <div class="text-xl mb-1">‚öîÔ∏è</div>
                                <div class="text-xs font-medium">Battle</div>
                            </button>
                        </div>
                    </div>
                `;
                
                this.welcomeScreen = document.getElementById('welcomeScreen');
                
                // Re-bind quick start events
                document.getElementById('quickStart1').addEventListener('click', () => this.loadPreset('debate'));
                document.getElementById('quickStart2').addEventListener('click', () => this.loadPreset('philosophy'));
                document.getElementById('quickStart3').addEventListener('click', () => this.loadPreset('tech'));
                document.getElementById('quickStart4').addEventListener('click', () => this.battleModeQuickStart());
                
                this.messageCount = 0;
                this.messageCounterEl.textContent = '0';
                this.conversationHistory = [];
            }

            exportConversation() {
                if (this.conversationHistory.length === 0) {
                    this.showToast('‚ùå No conversation to export!', 'error');
                    return;
                }

                const exportData = {
                    title: `AI Chat Arena - ${new Date().toLocaleDateString()}`,
                    timestamp: new Date().toISOString(),
                    duration: this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0,
                    settings: {
                        ai1Model: this.models[this.ai1ModelEl.value]?.name,
                        ai2Model: this.models[this.ai2ModelEl.value]?.name,
                        ai1Personality: this.ai1PromptEl.value,
                        ai2Personality: this.ai2PromptEl.value,
                        conversationStarter: this.conversationStarterEl.value,
                        battleMode: this.battleModeEl.checked,
                        maxMessages: this.maxMessagesEl.value
                    },
                    conversation: this.conversationHistory,
                    statistics: {
                        totalMessages: this.conversationHistory.length,
                        totalWords: this.conversationHistory.reduce((sum, msg) => sum + msg.wordCount, 0),
                        averageWordsPerMessage: Math.round(this.conversationHistory.reduce((sum, msg) => sum + msg.wordCount, 0) / this.conversationHistory.length),
                        retryCount: this.retryCount
                    },
                    finalScore: this.battleModeEl.checked ? {
                        ai1: this.ai1Score,
                        ai2: this.ai2Score,
                        winner: this.ai1Score > this.ai2Score ? 'AI 1' : (this.ai2Score > this.ai1Score ? 'AI 2' : 'Tie')
                    } : null
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai-chat-arena-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showToast('üíæ Conversation exported!', 'success');
            }

            shareConversation() {
                if (this.conversationHistory.length === 0) {
                    this.showToast('‚ùå No conversation to share!', 'error');
                    return;
                }

                const shareText = this.conversationHistory
                    .map(msg => `**${msg.sender}**: ${msg.message}`)
                    .join('\n\n');

                if (navigator.share) {
                    navigator.share({
                        title: 'AI Chat Arena Conversation',
                        text: shareText
                    });
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        this.showToast('üîó Copied to clipboard!', 'success');
                    });
                }
            }

            loadAnalytics() {
                const saved = localStorage.getItem('aiChatAnalytics');
                if (saved) {
                    this.analytics = { ...this.analytics, ...JSON.parse(saved) };
                }
            }

            saveAnalytics() {
                localStorage.setItem('aiChatAnalytics', JSON.stringify(this.analytics));
            }

            updateAnalyticsDisplay() {
                document.getElementById('totalConversations').textContent = this.analytics.totalConversations;
                document.getElementById('totalMessages').textContent = this.analytics.totalMessages;
                
                const avgResponseTime = this.analytics.responseTimes.length > 0 
                    ? Math.round(this.analytics.responseTimes.reduce((a, b) => a + b, 0) / this.analytics.responseTimes.length / 1000)
                    : 0;
                document.getElementById('avgResponseTime').textContent = `${avgResponseTime}s`;

                this.updateCharts();
            }

            updateCharts() {
                if (typeof Chart === 'undefined') return;

                // Model Usage Chart
                const modelCtx = document.getElementById('modelUsageChart').getContext('2d');
                new Chart(modelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(this.analytics.modelUsage),
                        datasets: [{
                            data: Object.values(this.analytics.modelUsage),
                            backgroundColor: ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6366f1']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        }
                    }
                });
            }
        }

        // Initialize the application
        const aiChat = new AIChat();
        window.aiChat = aiChat;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9799fab7836a003b',t:'MTc1Njk1MjEyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
